<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TijolÃ´metro â€” Cada Tijolo Conta</title>
<link rel="preconnect" href="https://docs.google.com"><link rel="dns-prefetch" href="https://docs.google.com">
<meta name="theme-color" content="#8B1E1E">
<style>
:root{
Â  --bg:#FFFAF5; --grout:#E5DBD1; --grid:#CDBFB3; --brick-bg-color:#a35a41;
Â  --pad:0px; --joint:0.8px; --ghost:0.12; --panel-max-width:1600px;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;display:flex;align-items:center;justify-content:center;padding:12px}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px) scale(.99)}to{opacity:1;transform:none}}
.panel{width:min(var(--panel-max-width),98vw);background:#fff;border-radius:20px;box-shadow:0 8px 30px rgba(0,0,0,.08);
Â  padding:16px;display:flex;flex-direction:column;gap:16px;animation:fadeIn .5s ease-out}
.gauge{position:relative;width:100%;border-radius:14px;overflow:hidden;background:#F7EFE7;min-height:300px}
.ghost-logo{position:absolute;inset:var(--pad);width:calc(100% - (var(--pad) * 2));height:calc(100% - (var(--pad) * 2));
Â  margin:auto;object-fit:contain;opacity:var(--ghost);filter:grayscale(1) sepia(1) brightness(1.5); z-index:30; pointer-events:none}
.bricks-bg{position:absolute;inset:0; z-index:4}
.mask-layer{position:absolute;inset:0;background:transparent;--mask:url('logo.png');
Â  -webkit-mask-image:var(--mask);mask-image:var(--mask);-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;
Â  -webkit-mask-position:center;mask-position:center;-webkit-mask-size:contain;mask-size:contain; z-index:8}
.bricks{position:relative;width:100%;height:100%}
.brick{position:absolute;background:var(--grout);border-radius:2px;overflow:hidden;box-shadow: inset 0 0 0 var(--joint) var(--grid); transform-origin: top left;}
.brick .fill{position:absolute;inset:0;width:0%;height:100%;background:var(--brick-bg-color);transition:width .35s ease}
.brick.filled .fill{width:100%}
/* sem animaÃ§Ã£o no primeiro paint */
.no-anim .brick .fill{ transition:none !important; }
/* reforÃ§o sutil do muro */
.bricks-bg .brick{
Â  box-shadow: inset 0 0 0 var(--joint) var(--grid), 0 0 0 1px rgba(0,0,0,.03);
}

.hud{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;padding:10px;border:1px solid #eee;border-radius:12px;background:#fdfdfd;font-variant-numeric:tabular-nums;align-items:center}
.hud .item{display:flex;flex-direction:column;gap:2px}
.hud .label{font-size:12px;color:#666}.hud .value{font-size:20px;font-weight:800}.hud .pct{font-weight:900}
.hud .updated{justify-self:end;font-size:11px;color:#777;text-align:right}
@media (max-width:740px){.hud{grid-template-columns:repeat(2,minmax(0,1fr))}.hud .updated{grid-column:1/-1;justify-self:start;text-align:left}}
.alert{position:absolute;left:14px;top:14px;background:#fff3cd;border:1px solid #ffe69c;color:#664d03;padding:8px 10px;border-radius:10px;font-size:12px;display:none}
.alert b{display:block;margin-bottom:4px}

/* Mascote (posicionamento por left/top; animaÃ§Ã£o no wrapper interno) */
.mascot{position:absolute;left:0;top:0;z-index:40;pointer-events:none;display:none;transition:left .28s cubic-bezier(.2,.8,.2,1), top .28s cubic-bezier(.2,.8,.2,1)}
.mascot img{display:block;width:110px;height:auto}
.carry-brick,.fx-brick{position:absolute;width:26px;height:14px;background:var(--brick-bg-color);border-radius:2px;box-shadow: inset 0 0 0 1px #8b6f5c}
.mascotWrap{display:inline-block}
@keyframes bob { 0%,100% { transform: translateY(0) rotate(0deg);} 50%{ transform: translateY(-4px) rotate(-0.4deg);} }
@keyframes wave{ 0%,100% { transform: rotate(0deg);} 50%{ transform: rotate(-12deg);} }
.mascotWrap.idle { animation: bob 3.5s ease-in-out infinite; }
.mascotWrap .carry-brick { transform-origin: 90% 120%; animation: wave 1.8s ease-in-out infinite; }

/* Tooltip */
#tip{
Â  position:fixed; z-index:10050; display:none;
Â  background:#fff; color:#111; border:1px solid #ddd; padding:8px 10px; border-radius:10px;
Â  box-shadow:0 8px 24px rgba(0,0,0,.18); max-width:320px; font:14px/1.3 system-ui; white-space:normal;
}
#tip .mini{ font-size:12px; color:#666; margin-top:4px }

body.embed{background:transparent}.hud.hidden{display:none}

/* -------- Painel de Controles -------- */
.fab{position:fixed;right:18px;bottom:18px;z-index:9998;width:54px;height:54px;border-radius:50%;
Â  background:#0A4AA6;color:#fff;display:flex;align-items:center;justify-content:center;
Â  box-shadow:0 12px 28px rgba(0,0,0,.18);cursor:pointer;font-size:22px}
.fab:active{transform:scale(.98)}
.drawer{position:fixed;inset:0 0 0 auto;width:340px;max-width:92vw;background:#fff;border-left:1px solid #eee;box-shadow:-16px 0 40px rgba(0,0,0,.18);
Â  transform:translateX(105%);transition:transform .28s ease;z-index:9999;display:flex;flex-direction:column}
.drawer.open{transform:none}
.drawer .head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eee}
.drawer .body{padding:12px 16px 18px;overflow:auto}
.drawer h4{margin:14px 0 8px 0}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.row label{font-size:13px;color:#333}
select,input[type="text"],input[type="number"]{font:inherit;padding:6px 8px;border:1px solid #ddd;border-radius:8px;background:#fff}
.switch{appearance:none;width:42px;height:24px;background:#ddd;border-radius:999px;position:relative;outline:none;cursor:pointer}
.switch:checked{background:#0A4AA6}
.switch::after{content:"";position:absolute;left:2px;top:2px;width:20px;height:20px;border-radius:999px;background:#fff;transition:left .18s}
.switch:checked::after{left:20px}
.slider{width:100%}
.btn{padding:8px 12px;border-radius:10px;border:1px solid #ddd;background:#fafafa;cursor:pointer}
.btn.primary{background:#0A4AA6;color:#fff;border-color:#0A4AA6}
.small{font-size:12px;color:#666}
.small.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.debug-row{opacity:0.7}
</style>
</head>
<body>
Â  <div id="debug-console" style="position: fixed; bottom: 0; left: 0; width: 100%; max-height: 25vh; background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace; font-size: 10px; z-index: 99999; padding: 5px; overflow-y: scroll; border-top: 2px solid #333;">
Â  <strong>--- CONSOLE DE DEBUG ---</strong><br>
</div>
Â  <div class="panel">
Â  Â  <div class="gauge" id="gauge">
Â  Â  Â  <div class="alert" id="logoAlert"><b>Logo nÃ£o carregou</b> â€” verifique o arquivo logo.png.</div>

Â  Â  Â  <img class="ghost-logo" id="ghostLogo" alt="logo" />

Â  Â  Â  <div class="mascot" id="mascot" aria-hidden="true">
Â  Â  Â  Â  <div class="mascotWrap" id="mascotWrap">
Â  Â  Â  Â  Â  <img id="mascotImg" src="Tio_Jolinho_tijolo.png" alt="Tio Jolinho">
Â  Â  Â  Â  Â  <div class="carry-brick" id="carryBrick" style="left:64px;top:58px"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="bricks-bg" id="bricksBg"></div>
Â  Â  Â  <div class="mask-layer" id="mask"><div class="bricks" id="bricksFg"></div></div>
Â  Â  </div>

Â  Â  <div class="hud" id="hud">
Â  Â  Â  <div class="item"><span class="label">Arrecadado</span><span class="value" id="hudRaised">R$ 0,00</span></div>
Â  Â  Â  <div class="item"><span class="label" id="hudGoalLabel">Meta</span><span class="value" id="hudGoal">R$ 0,00</span></div>
Â  Â  Â  <div class="item"><span class="label">Progresso</span><span class="value pct" id="hudPct">0%</span></div>
Â  Â  Â  <div class="updated" id="hudUpdated">â€”</div>
Â  Â  </div>
Â  </div>

Â  <div id="tip"></div>

Â  <button class="fab" id="fab" title="OpÃ§Ãµes">âš™ï¸</button>
Â  <aside class="drawer" id="drawer" aria-label="Controles do TijolÃ´metro">
Â  Â  <div class="head">
Â  Â  Â  <strong>OpÃ§Ãµes do TijolÃ´metro</strong>
Â  Â  Â  <button class="btn" id="closeDrawer">Fechar</button>
Â  Â  </div>
Â  Â  <div class="body">
Â  Â  Â  <h4>Mascote</h4>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <label>Mostrar:</label><input id="optMascotOn" class="switch" type="checkbox" checked>
Â  Â  Â  </div>
Â  Â  Â  <div class="row" style="margin-top:8px">
Â  Â  Â  Â  <label>Imagem:</label>
Â  Â  Â  Â  <select id="optMascotSrc">
Â  Â  Â  Â  Â  <option>Tio_Jolinho_tijolo.png</option>
Â  Â  Â  Â  Â  <option>Tio_Jolinho_carrinho.png</option>
Â  Â  Â  Â  Â  <option>Tio_Jolinho_martelo.png</option>
Â  Â  Â  Â  Â  <option>Sr._Construtino_colher.png</option>
Â  Â  Â  Â  Â  <option>Lumininha_trena.png</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>
Â  Â  Â  <div class="row" style="margin-top:8px">
Â  Â  Â  Â  <label>X (%):</label><input id="optMascotX" type="number" min="0" max="100" step="0.5" style="width:84px">
Â  Â  Â  Â  <label>Y (%):</label><input id="optMascotY" type="number" min="0" max="100" step="0.5" style="width:84px">
Â  Â  Â  </div>

Â  Â  Â  <h4>Doadores</h4>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <label>Tooltip de doadores:</label><input id="optDonorsOn" class="switch" type="checkbox">
Â  Â  Â  </div>
Â  Â  Â  <div class="row" style="margin-top:8px">
Â  Â  Â  Â  <label>Exibir nome:</label>
Â  Â  Â  Â  <select id="optNamesMode">
Â  Â  Â  Â  Â  <option value="first">Nome curto</option>
Â  Â  Â  Â  Â  <option value="full">Nome completo</option>
Â  Â  Â  Â  Â  <option value="off">Ocultar</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>
Â  Â  Â  <div class="row debug-row" style="margin-top:6px">
Â  Â  Â  Â  <span class="small">Aba:</span><span class="small mono" id="dbgSheet">TIJOLO_Respostas</span>
Â  Â  Â  </div>
Â  Â  Â  <div class="row debug-row" style="margin-top:2px">
Â  Â  Â  Â  <span class="small">CabeÃ§alho:</span><span class="small mono" id="dbgHeader">Texto do tijolo 1 (mÃ¡x. 40)</span>
Â  Â  Â  </div>
Â  Â  Â  <div class="row debug-row" style="margin-top:2px">
Â  Â  Â  Â  <span class="small">Status doadores:</span><span class="small" id="dbgDonors">â€”</span>
Â  Â  Â  </div>

Â  Â  Â  <h4>HUD</h4>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <label>Exibir painel:</label><input id="optHudOn" class="switch" type="checkbox" checked>
Â  Â  Â  </div>

Â  Â  Â  <h4>AÃ§Ãµes</h4>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <button class="btn" id="btnRefresh">Atualizar agora</button>
Â  Â  Â  Â  <button class="btn" id="btnSimulate">Simular 100%</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="row" style="margin-top:8px">
Â  Â  Â  Â  <button class="btn primary" id="btnCopyLink">Copiar link com estas opÃ§Ãµes</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="row" style="margin-top:8px">
Â  Â  Â  Â  <button class="btn" id="btnReset">Restaurar padrÃ£o</button>
Â  Â  Â  Â  <span class="small">PreferÃªncias sÃ£o salvas no seu navegador.</span>
Â  Â  Â  </div>
Â  Â  </div>
Â  </aside>

<script>
(function(){
Â  /* ---------- parÃ¢metros e defaults ---------- */
Â  const qs=new URLSearchParams(location.search);
Â  const DEFAULTS={
Â  Â  // Planilha do PAINEL
Â  Â  sheetId:'1-_J2DwVSn7LULB55YVPCHQsQ-PRfZYt8oDJhepdXYFY',
Â  Â  sheetName:'Tijolometro', range:'A1:D10',

Â  Â  // Doadores (Forms) â€” por CABEÃ‡ALHO
Â  Â  donorsOn:true,
Â  Â  donorsSheetId:'1CbyqJL0lpYAzxBXRw9dvUh5DHh50imJOw5AUjVALy8I',
Â  Â  donorsSheet:'TIJOLO_Respostas',
Â  Â  donorsHeader:'Texto do tijolo 1 (mÃ¡x. 40)',
Â  Â  donorsRange:'A1:Z10000',
Â  Â  namesMode:'first',

Â  Â  logo:'logo.png', cols:120, rows:72, brickPx:0, targetBricks:0, gap:1,
Â  Â  pollMs:30000, pad:0, grout:'', joint:'', ghost:'', palette:'brand3',
Â  Â  embed:false, hudOff:false,
Â  Â  mascot:true, mascotSrc:'Tio_Jolinho_tijolo.png', respectMotion:false,
Â  Â  mascotX:'90%', mascotY:'75%',
Â  Â  brickScale:1.0Â  // FIXO: escala visual em 100%
Â  };

Â  function loadSaved(){ try{ return JSON.parse(localStorage.getItem('tj:settings')||'{}'); }catch{return{}} }
Â  const SAVED=loadSaved();

Â  // merge: URL > saved > defaults
Â  const CONFIG={...DEFAULTS,...SAVED,
Â  Â  ...Object.fromEntries([...qs.entries()].map(([k,v])=>{
Â  Â  Â  if(['brick_px','cols','rows','gap','poll_ms','pad','target_bricks'].includes(k)) return [toKey(k), +v];
Â  Â  Â  if(['brick_scale'].includes(k)) return [toKey(k), +v];
Â  Â  Â  if(['donors','embed','hud','mascot','respect_motion'].includes(k)) return [toKey(k), v==='1'];
Â  Â  Â  if(['mascot_x','mascot_y'].includes(k)) return [toKey(k), v];
Â  Â  Â  return [toKey(k), v];
Â  Â  }))
Â  };
Â Â 
Â  // ForÃ§a as configuraÃ§Ãµes fixas para nÃ£o serem sobrescritas
Â  CONFIG.palette = 'brand3';
Â  CONFIG.brickScale = 1.0;
Â Â 
Â  function toKey(k){return ({
Â  Â  'sheet_id':'sheetId','sheet':'sheetName','range':'range',
Â  Â  'donors':'donorsOn','donors_sheet':'donorsSheet','donors_range':'donorsRange','donors_sheet_id':'donorsSheetId','donors_header':'donorsHeader','names':'namesMode',
Â  Â  'logo':'logo','cols':'cols','rows':'rows','brick_px':'brickPx','gap':'gap','poll_ms':'pollMs','pad':'pad','palette':'palette',
Â  Â  'embed':'embed','hud':'hudOn','target_bricks':'targetBricks','mascot':'mascot','mascot_src':'mascotSrc','respect_motion':'respectMotion',
Â  Â  'mascot_x':'mascotX','mascot_y':'mascotY','brick_scale':'brickScale'
Â  }[k]||k)}

Â  // aplicar variÃ¡veis de estilo opcionais
Â  if (CONFIG.pad) document.documentElement.style.setProperty('--pad', CONFIG.pad+'px');
Â  if (CONFIG.grout) document.documentElement.style.setProperty('--grout', CONFIG.grout);
Â  if (CONFIG.joint) document.documentElement.style.setProperty('--joint', CONFIG.joint+'px');
Â  if (CONFIG.ghost) document.documentElement.style.setProperty('--ghost', CONFIG.ghost);
Â  if (CONFIG.embed) document.body.classList.add('embed');

Â  /* ---------- elementos ---------- */
Â  const gauge=document.getElementById('gauge'), maskEl=document.getElementById('mask'),
Â  Â  Â  Â  ghostEl=document.getElementById('ghostLogo'), bricksFgEl=document.getElementById('bricksFg'),
Â  Â  Â  Â  bricksBgEl=document.getElementById('bricksBg'), alertBox=document.getElementById('logoAlert');
Â  const hud={raised:document.getElementById('hudRaised'),goal:document.getElementById('hudGoal'),
Â  Â  Â  Â  Â  Â  Â pct:document.getElementById('hudPct'),updated:document.getElementById('hudUpdated'),
Â  Â  Â  Â  Â  Â  Â goalLabel:document.getElementById('hudGoalLabel'), box:document.getElementById('hud')};
Â  const mascotBox=document.getElementById('mascot'), mascotImg=document.getElementById('mascotImg'), mascotWrap=document.getElementById('mascotWrap');
Â  const tip=document.getElementById('tip');

Â  // controls
Â  const fab=document.getElementById('fab'), drawer=document.getElementById('drawer'),
Â  Â  Â  Â  closeDrawer=document.getElementById('closeDrawer'),
Â  Â  Â  Â  optMascotOn=document.getElementById('optMascotOn'),
Â  Â  Â  Â  optMascotSrc=document.getElementById('optMascotSrc'),
Â  Â  Â  Â  optMascotX=document.getElementById('optMascotX'),
Â  Â  Â  Â  optMascotY=document.getElementById('optMascotY'),
Â  Â  Â  Â  optDonorsOn=document.getElementById('optDonorsOn'),
Â  Â  Â  Â  optNamesMode=document.getElementById('optNamesMode'),
Â  Â  Â  Â  optHudOn=document.getElementById('optHudOn'),
Â  Â  Â  Â  btnRefresh=document.getElementById('btnRefresh'),
Â  Â  Â  Â  btnSimulate=document.getElementById('btnSimulate'),
Â  Â  Â  Â  btnCopyLink=document.getElementById('btnCopyLink'),
Â  Â  Â  Â  btnReset=document.getElementById('btnReset'),
Â  Â  Â  Â  dbgDonors=document.getElementById('dbgDonors'),
Â  Â  Â  Â  dbgSheet=document.getElementById('dbgSheet'),
Â  Â  Â  Â  dbgHeader=document.getElementById('dbgHeader');

Â  dbgSheet.textContent = CONFIG.donorsSheet;
Â  dbgHeader.textContent = CONFIG.donorsHeader;

Â  /* ---------- estado de desenho ---------- */
Â  const paintCanvas=document.createElement('canvas');
Â  const pctx=paintCanvas.getContext('2d',{willReadFrequently:true});
Â  let logoImg=null,aspectSet=false,bricksFg=[],bricksBg=[],effCols,effRows,lastProgress=0,lastFilled=0,donors=[];
Â  let firstApplyDone=false; // para tirar animaÃ§Ãµes no primeiro paint
Â  let lastGoalValue=0, lastRaisedValue=0; // para simulaÃ§Ã£o visual

Â  function setMaskImage(url){ maskEl.style.setProperty('--mask', `url('${url}')`); }
Â  function formatBRL(n){ try{return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0}).format(n);}catch{return 'R$ '+Number(n||0).toLocaleString('pt-BR');} }
Â  function tweenNumber(el,to,fmt,ms=600){ const from=Number((el.textContent||'0').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',','.'))||0;
Â  Â  const t0=performance.now(); (function f(t){const k=Math.min(1,(t-t0)/ms);el.textContent=fmt(from+(to-from)*k); if(k<1)requestAnimationFrame(f)})(t0); }
Â  function firstName(n){ if(!n) return ''; const p=n.trim().split(/\s+/); return p[0]+(p[1]?' '+p[1][0]+'.':''); }
Â  function formatName(n){ if(CONFIG.namesMode==='off') return ''; if(CONFIG.namesMode==='full') return n||''; return firstName(n||''); }

Â  function loadLogo(src){ return new Promise(res=>{ const im=new Image();
Â  Â  im.onload=()=>{logoImg=im;ghostEl.src=im.src;setMaskImage(im.src);alertBox.style.display='none';res(true)};
Â  Â  im.onerror=()=>{alertBox.style.display='block';res(false)};
Â  Â  im.src=src+(src.includes('?')?'&':'?')+'t='+Date.now();
Â  })}

Â  function ensureAspectFromLogo(){ if(aspectSet||!logoImg) return; const ar=logoImg.naturalWidth/logoImg.naturalHeight; if(ar>0) gauge.style.aspectRatio=`${ar} / 1`; aspectSet=true; }

Â  const PALETTES={brand2:['#0A4AA6','#F2C035'],brand3:['#0A4AA6','#F2C035','#8B1E1E']};
Â  const hexToRgb=h=>{const n=parseInt(h.replace('#',''),16);return{r:(n>>16)&255,g:(n>>8)&255,b:n&255}};
Â  const dist2=(c1,c2)=>{const dr=c1.r-c2.r,dg=c1.g-c2.g,db=c1.b-c2.b;return dr*dr+dg*dg+db*db};
Â  function mapToPalette(r,g,b,name){const set=PALETTES[name];if(!set)return`rgb(${r},${g},${b})`;let best=set[0],bestD=Infinity,c1={r,g,b};
Â  Â  for(const h of set){const c2=hexToRgb(h);const d=dist2(c1,c2);if(d<bestD){bestD=d;best=h}}return best}
Â  const makeSampler=(data,W,H)=>(x,y)=>{const xi=Math.max(0,Math.min(W-1,Math.round(x))), yi=Math.max(0,Math.min(H-1,Math.round(y))), i=(yi*W+xi)*4; return [data[i],data[i+1],data[i+2],data[i+3]]};
Â  const median=a=>{const b=a.slice().sort((m,n)=>m-n);return b[Math.floor(b.length/2)]};
Â  function darkenHex(hex, amt=0.15){
Â  Â  const c = hexToRgb(hex);
Â  Â  const k = Math.max(0, Math.min(1, 1-amt));
Â  Â  return `rgb(${Math.round(c.r*k)},${Math.round(c.g*k)},${Math.round(c.b*k)})`;
Â  }

// Colorize com muro de fundo forte e logo destacado
Â  function colorizeBricks(){
Â  Â  if(!logoImg) return; const W=bricksFgEl.clientWidth,H=bricksFgEl.clientHeight;if(!W||!H) return;
Â  Â  paintCanvas.width=W;paintCanvas.height=H;pctx.clearRect(0,0,W,H);
Â  Â  const ar=logoImg.naturalWidth/logoImg.naturalHeight;let dw=W,dh=W/ar;if(dh>H){dh=H;dw=H*ar}
Â  Â  const dx=(W-dw)/2,dy=(H-dh)/2;pctx.drawImage(logoImg,dx,dy,dw,dh);
Â  Â  const buf=pctx.getImageData(0,0,W,H).data;const samp=makeSampler(buf,W,H);
Â  Â  const baseHex = getComputedStyle(document.documentElement).getPropertyValue('--brick-bg-color').trim() || '#a35a41';
Â  Â  for(let i=0;i<bricksFg.length;i++){
Â  Â  Â  const bFg=bricksFg[i],bBg=bricksBg[i];const x=bFg._x,y=bFg._y,w=bFg._w,h=bFg._h;
Â  Â  Â  const pts=[[x+w/2,y+h/2],[x+1,y+1],[x+w-2,y+1],[x+1,y+h-2],[x+w-2,y+h-2],[x+w/2,y+1],[x+w/2,y+h-2],[x+1,y+h/2],[x+w-2,y+h/2]];
Â  Â  Â  const rs=[],gs=[],bs=[],as=[];for(const [px,py] of pts){const d=samp(px,py);rs.push(d[0]);gs.push(d[1]);bs.push(d[2]);as.push(d[3])}
Â  Â  Â  Â const A=median(as);const fg=bFg.querySelector('.fill'), bg=bBg.querySelector('.fill');
// =============== INÃCIO DO CÃ“DIGO DE DEBUG (VERSÃƒO COM MIRA) ===============
if (i % 200 === 0) { // Inspeciona 1 a cada 200 tijolos
Â  Â  const debugConsole = document.getElementById('debug-console');
Â  Â  if (debugConsole) {
Â  Â  Â  Â  // --- NOVIDADE: PINTANDO A BORDA DO TIJOLO ALVO ---
Â  Â  Â  Â  const tijoloInspecionado = bricksFg[i];
Â  Â  Â  Â  if (tijoloInspecionado) {
Â  Â  Â  Â  Â  Â  tijoloInspecionado.style.outline = '1px solid red';
Â  Â  Â  Â  Â  Â  tijoloInspecionado.style.outlineOffset = '-1px';
Â  Â  Â  Â  }
Â  Â  Â  Â  // --- FIM DA NOVIDADE ---

Â  Â  Â  Â  const r = median(rs), g = median(gs), b = median(bs);
Â  Â  Â  Â  const corMapeada = mapToPalette(r, g, b, CONFIG.palette);
Â  Â  Â  Â  const A_max = Math.max.apply(null, as);
Â  Â  Â  Â  const estaDentro = A_max >= 20;

Â  Â  Â  Â  let output = `------------------------------------<br>`;
Â  Â  Â  Â  output += `<b>TIJOLO VERMELHO (Ãndice: ${i})</b><br>`; // Adicionado um tÃ­tulo para fÃ¡cil identificaÃ§Ã£o
Â  Â  Â  Â  output += `XY: ${Math.round(x)}, ${Math.round(y)} | `;
Â  Â  Â  Â  output += `A_max: ${A_max} | Dentro?: ${estaDentro}<br>`;
Â  Â  Â  Â  output += `Cor (RGB): ${r}, ${g}, ${b} | `;
Â  Â  Â  Â  output += `Paleta: ${corMapeada}<br>`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Adiciona a nova mensagem no topo do console, para ficar mais fÃ¡cil de ver
Â  Â  Â  Â  debugConsole.innerHTML = output + debugConsole.innerHTML;
Â  Â  }
}
// =============== FIM DO CÃ“DIGO DE DEBUG (VERSÃƒO COM MIRA) ===============
Â  Â  Â  // MUDANÃ‡A DRASTICA: Agora, apenas pixels 100% transparentes serÃ£o considerados "fundo".
Â  Â  Â  if (A === 0) {
Â  Â  Â  Â  // FORA do logo (muro de fundo): tijolo forte e visÃ­vel (camada de fundo)
Â  Â  Â  Â  fg.style.background = 'transparent';
Â  Â  Â  Â  const base = hexToRgb(baseHex);
Â  Â  Â  Â  bg.style.background = `rgb(${base.r},${base.g},${base.b})`;
Â  Â  Â  Â  bg.style.opacity = '1';
Â  Â  Â  } else {
Â  Â  Â  Â  // DENTRO do logo: usar a cor da paleta (mapeada do logo) com um leve â€œboostâ€ de contraste
Â  Â  Â  Â  const r=median(rs),g=median(gs),b=median(bs);
Â  Â  Â  Â  const pc = mapToPalette(r,g,b,CONFIG.palette);
Â  Â  Â  Â  fg.style.background = darkenHex(pc, 0.15); // 15% mais â€œvivoâ€
Â  Â  Â  Â  bg.style.opacity='0';
Â  Â  Â  }
Â  Â  }
Â  }

Â  let _orderFg=[],_orderBg=[];
Â  function buildOrder(rows,cols){const of=[],ob=[];for(let r=rows-1;r>=0;r--){for(let c=0;c<cols;c++){const i=r*cols+c;of.push(bricksFg[i]);ob.push(bricksBg[i])}} _orderFg=of;_orderBg=ob; assignDonorsToBricks(); }

Â  function layoutBricks(){
Â  Â  ensureAspectFromLogo(); const W=bricksFgEl.clientWidth,H=bricksFgEl.clientHeight;if(!W||!H) return;

Â  Â  if(CONFIG.targetBricks>0){
Â  Â  Â  const ar=W/H;
Â  Â  Â  const rows=Math.max(12,Math.round(Math.sqrt(CONFIG.targetBricks/(ar*1.0))));
Â  Â  Â  const cols=Math.max(20,Math.round(rows*ar));
Â  Â  Â  effCols=cols;effRows=rows;
Â  Â  }
Â  Â  const cols=(typeof effCols==='number'&&effCols>0)?effCols:CONFIG.cols;
Â  Â  const rows=(typeof effRows==='number'&&effRows>0)?effRows:CONFIG.rows;

Â  Â  const gap=CONFIG.gap; let brickW=Math.floor((W-(cols+1)*gap)/cols); if(brickW<2)brickW=2;
Â  Â  let offset=Math.floor(brickW/2); let gridWEven=cols*brickW+(cols+1)*gap; let gridWOdd=gridWEven+offset;
Â  Â  if(gridWOdd>W){const extra=gridWOdd-W;const reduce=Math.ceil(extra/cols);brickW=Math.max(2,brickW-reduce);offset=Math.floor(brickW/2);gridWEven=cols*brickW+(cols+1)*gap;gridWOdd=gridWEven+offset}
Â  Â  const brickH=Math.max(2,Math.floor((H-(rows+1)*gap)/rows));
Â  Â  const gridWMax=Math.max(gridWEven,gridWOdd);
Â  Â  const startXBase=Math.max(gap,Math.floor((W-gridWMax)/2)+gap);

Â  Â  const total=rows*cols;
Â  Â  if(bricksFg.length!==total){
Â  Â  Â  bricksFgEl.innerHTML='';bricksBgEl.innerHTML='';bricksFg=[];bricksBg=[];
Â  Â  Â  const fragFg=document.createDocumentFragment(),fragBg=document.createDocumentFragment();
Â  Â  Â  for(let i=0;i<total;i++){
Â  Â  Â  Â  const f=document.createElement('div'); f.className='brick'; f.dataset.idx=i;
Â  Â  Â  Â  const ffill=document.createElement('div'); ffill.className='fill'; f.appendChild(ffill);
Â  Â  Â  Â  fragFg.appendChild(f); bricksFg.push(f);
Â  Â  Â  Â  const b=document.createElement('div'); b.className='brick';
Â  Â  Â  Â  const bfill=document.createElement('div'); bfill.className='fill'; b.appendChild(bfill);
Â  Â  Â  Â  fragBg.appendChild(b); bricksBg.push(b);
Â  Â  Â  }
Â  Â  Â  bricksFgEl.appendChild(fragFg); bricksBgEl.appendChild(fragBg);
Â  Â  }

Â  Â  const scale = Math.max(0.6, Math.min(1.0, CONFIG.brickScale||1.0));
Â  Â  let idx=0;
Â  Â  for(let r=0;r<rows;r++){
Â  Â  Â  const startX=startXBase+(r%2?offset:0);
Â  Â  Â  for(let c=0;c<cols;c++){
Â  Â  Â  Â  const x=startX+c*(brickW+gap),y=gap+r*(brickH+gap);
Â  Â  Â  Â  const F=bricksFg[idx]; F.style.cssText=`left:${x}px;top:${y}px;width:${brickW}px;height:${brickH}px; transform:scale(${scale});`; F._x=x;F._y=y;F._w=brickW;F._h=brickH;
Â  Â  Â  Â  const B=bricksBg[idx]; B.style.cssText=`left:${x}px;top:${y}px;width:${brickW}px;height:${brickH}px; transform:scale(${scale});`;
Â  Â  Â  Â  idx++;
Â  Â  Â  }
Â  Â  }

Â  Â  buildOrder(rows,cols);
Â  Â  colorizeBricks();
Â  Â  applyProgress(lastProgress, /*skipThrow*/ true);
Â  Â  if(CONFIG.mascot) setMascotByAnchor();
Â  }

Â  function applyProgress(p, skipThrow){
Â  Â  p=Math.max(0,Math.min(1,p||0)); lastProgress=p;

Â  Â  if(!firstApplyDone){ document.body.classList.add('no-anim'); }

Â  Â  const of=_orderFg,ob=_orderBg,total=of.length; if(!total) return;
Â  Â  const filled=Math.floor(p*total), frac=(p*total)-filled;
Â  Â  for(let i=0;i<total;i++){
Â  Â  Â  const fF=of[i].querySelector('.fill'), fB=ob[i].querySelector('.fill');
Â  Â  Â  of[i].classList.remove('filled','partial'); fF.style.width='0%';
Â  Â  Â  ob[i].classList.remove('filled','partial'); fB.style.width='0%';
Â  Â  Â  if(i<filled){ of[i].classList.add('filled'); fF.style.width='100%'; ob[i].classList.add('filled'); fB.style.width='100%'; }
Â  Â  }
Â  Â  if(filled<total){
Â  Â  Â  const fF=of[filled].querySelector('.fill'), fB=ob[filled].querySelector('.fill');
Â  Â  Â  const percent=Math.round(frac*100)+'%';
Â  Â  Â  of[filled].classList.add('partial'); fF.style.width=percent;
Â  Â  Â  ob[filled].classList.add('partial'); fB.style.width=percent;
Â  Â  }

Â  Â  if(!firstApplyDone){
Â  Â  Â  firstApplyDone=true;
Â  Â  Â  requestAnimationFrame(()=> document.body.classList.remove('no-anim'));
Â  Â  }

Â  Â  if (!skipThrow && CONFIG.mascot && filled > lastFilled){
Â  Â  Â  throwBrickTo(of[filled-1]||of[0]);
Â  Â  Â  lastFilled=filled;
Â  Â  }
Â  }

Â  function setMascotByAnchor(){
Â  Â  if(!CONFIG.mascot){ mascotBox.style.display='none'; return; }
Â  Â  if(CONFIG.respectMotion && matchMedia('(prefers-reduced-motion: reduce)').matches){ mascotBox.style.display='none'; return; }
Â  Â  mascotImg.src=CONFIG.mascotSrc;
Â  Â  mascotBox.style.display='block';
Â  Â  mascotWrap.classList.add('idle');

Â  Â  const gR=gauge.getBoundingClientRect();
Â  Â  const xp = String(CONFIG.mascotX ?? '').toLowerCase().includes('%')
Â  Â  Â  ? (parseFloat(CONFIG.mascotX)/100)*gR.width
Â  Â  Â  : parseFloat(CONFIG.mascotX||0);
Â  Â  const yp = String(CONFIG.mascotY ?? '').toLowerCase().includes('%')
Â  Â  Â  ? (parseFloat(CONFIG.mascotY)/100)*gR.height
Â  Â  Â  : parseFloat(CONFIG.mascotY||0);
Â  Â  const x = Math.round(xp - 55);
Â  Â  const y = Math.round(yp - 60);
Â  Â  mascotBox.style.left = x + 'px';
Â  Â  mascotBox.style.topÂ  = y + 'px';
Â  }

Â  let __throwLock = false;
Â  function throwBrickTo(brick){
Â  Â  if(!brick || !firstApplyDone || __throwLock) return;
Â  Â  __throwLock = true;
Â  Â  const fx=document.createElement('div'); fx.className='fx-brick'; gauge.appendChild(fx);
Â  Â  const gR=gauge.getBoundingClientRect(), bR=brick.getBoundingClientRect(), mR=mascotBox.getBoundingClientRect();
Â  Â  const sx=mR.left-gR.left+76, sy=mR.top-gR.top+78;
Â  Â  const tx=bR.left-gR.left + bR.width/2 -13, ty=bR.top-gR.top + bR.height/2 -7;
Â  Â  fx.style.left=sx+'px'; fx.style.top=sy+'px';
Â  Â  fx.style.transition='transform 1.3s cubic-bezier(.2,.7,.2,1), opacity 1.3s';
Â  Â  fx.style.transform = 'translate(0,0) scale(0.9)';
Â  Â  requestAnimationFrame(()=>{
Â  Â  Â  fx.style.transform=`translate(${Math.round(tx-sx)}px,${Math.round(ty-sy)}px) scale(1.02)`;
Â  Â  Â  fx.style.opacity='1';
Â  Â  });
Â  Â  setTimeout(()=>{
Â  Â  Â  fx.style.opacity='0';
Â  Â  Â  setTimeout(()=>{ fx.remove(); __throwLock = false; }, 320);
Â  Â  }, 1300);
Â  }

Â  function assignDonorsToBricks(){
Â  Â  const of=_orderFg;
Â  Â  for(let i=0;i<of.length;i++){ of[i]._donor = (donors && donors.length) ? donors[i % donors.length] : null; }
Â  }

Â  let tipTimer=null;
Â  bricksFgEl.addEventListener('click', onBrickTap, {passive:true});
Â  bricksFgEl.addEventListener('touchstart', onBrickTap, {passive:true});
Â  function onBrickTap(e){
Â  Â  const brick=e.target.closest('.brick'); if(!brick||!bricksFgEl.contains(brick)) return;
Â  Â  const donor=brick._donor;
Â  Â  const r=brick.getBoundingClientRect();

Â  Â  const hasDonor = !!(CONFIG.donorsOn && donor);
Â  Â  const showPersonal = hasDonor && CONFIG.namesMode !== 'off';

Â  Â  let displayName = '';
Â  Â  if (showPersonal && donor.name) {
Â  Â  Â  displayName = (CONFIG.namesMode === 'full') ? (donor.name || '') : firstName(donor.name || '');
Â  Â  }
Â  Â  const donorTitle = showPersonal && displayName
Â  Â  Â  ? `<b>${displayName}</b>`
Â  Â  Â  : `<b>Obrigado!</b>`;

Â  Â  const showMsg = showPersonal && donor && donor.msg;

Â  Â  const html = showMsg
Â  Â  Â  ? `${donorTitle}<div>${donor.msg}</div><div class="mini">${donor.value?('Doou '+formatBRL(donor.value)):'Cada tijolo conta ğŸ’›'}</div>`
Â  Â  Â  : `${donorTitle}<div class="mini">Cada tijolo conta ğŸ’›</div>`;

Â  Â  tip.innerHTML=html; tip.style.display='block';
Â  Â  const left=Math.min(Math.max(8,r.left+r.width/2), innerWidth-320); const top=Math.max(8,r.top-12);
Â  Â  tip.style.left=left+'px'; tip.style.top=top+'px';
Â  Â  clearTimeout(tipTimer); tipTimer=setTimeout(()=> tip.style.display='none', 3000);
Â  Â  if(CONFIG.mascot){ setMascotByAnchor(); throwBrickTo(brick); }
Â  }

Â  function parseDateCell(cell){
Â  Â  let v=(cell&&typeof cell==='object'&&'v'in cell)?cell.v:cell;
Â  Â  if(v&&typeof v==='object'){ if('f'in v&&typeof v.f==='string')return parseDateCell(v.f); if('v'in v) return parseDateCell(v.v); }
Â  Â  if(!v) return null;
Â  Â  if(typeof v==='string'){
Â  Â  Â  const gv=v.match(/Date\((\d+),\s*(\d+),\s*(\d+)/i); if(gv) return new Date(+gv[1],+gv[2],+gv[3]);
Â  Â  Â  const iso=v.match(/^(\d{4})[-\/.](\d{1,2})[-\/.](\d{1,2})$/); if(iso) return new Date(+iso[1],+iso[2]-1,+iso[3]);
Â  Â  Â  const br=v.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/); if(br){const d=+br[1],m=+br[2],y=+br[3]<100?2000+ +br[3]:+br[3];return new Date(y,m-1,d)}
Â  Â  Â  return null;
Â  Â  }
Â  Â  if(typeof v==='number'){const base=Date.UTC(1899,11,30);return new Date(base+v*86400*1000)}
Â  Â  return null;
Â  }

Â  async function fetchProgress(){
Â  Â  const base=`https://docs.google.com/spreadsheets/d/${CONFIG.sheetId}/gviz/tq`;
Â  Â  const params=new URLSearchParams({tqx:'out:json',sheet:CONFIG.sheetName,range:CONFIG.range,t:Date.now()+''});
Â  Â  try{
Â  Â  Â  const res=await fetch(`${base}?${params}`,{cache:'no-store'}); const txt=await res.text();
Â  Â  Â  const m=txt.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
Â  Â  Â  if (!m || !m[1]) { throw new Error('Invalid Gviz response format'); }
Â  Â  Â  const data=JSON.parse(m[1]); const rows=data?.table?.rows||[];
Â  Â  Â  let raised=0; const campaigns=[];
Â  Â  Â  for(const r of rows){
Â  Â  Â  Â  const label=r.c?.[0]?.v?.toString().trim(); if(!label) continue;
Â  Â  Â  Â  const value=Number(r.c?.[1]?.v || r.c?.[1]?.f || 0);
Â  Â  Â  Â  if(label.toLowerCase()==='arrecadado'){ raised=Number(value||0); continue; }
Â  Â  Â  Â  const start=parseDateCell(r.c?.[2]); const end=parseDateCell(r.c?.[3]);
Â  Â  Â  Â  campaigns.push({label,goal:Number(value||0),start,end});
Â  Â  Â  }
Â  Â  Â  const today=new Date(); today.setHours(0,0,0,0);
Â  Â  Â  let active=campaigns.find(c=>c.start&&c.end&&today>=c.start&&today<=c.end);
Â  Â  Â  if(!active) active=campaigns.find(c=>c.goal>0) || {label:'Meta',goal:0};
Â  Â  Â  const goal=Number(active.goal||0);
Â  Â  Â  const pRaw=goal>0 ? (raised/goal) : 0; const p=Math.max(0,Math.min(1,pRaw));

Â  Â  Â  lastGoalValue = goal;
Â  Â  Â  lastRaisedValue = raised;

Â  Â  Â  applyProgress(p);
Â  Â  Â  tweenNumber(hud.raised, raised, n=>formatBRL(n)); tweenNumber(hud.goal, goal, n=>formatBRL(n));
Â  Â  Â  hud.goalLabel.textContent=active.label||'Meta';
Â  Â  Â  hud.pct.textContent=(pRaw*100).toFixed(1).replace('.',',')+'%';
Â  Â  Â  hud.updated.textContent='Atualizado em '+new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});

Â  Â  Â  try{localStorage.setItem('tj:last',JSON.stringify({p,raised,goal,ts:Date.now()}));}catch{}
Â  Â  Â  return {ok:true, raised, goal, p};
Â  Â  }catch(e){
Â  Â  Â  console.error('Erro ao buscar planilha:',e);
Â  Â  Â  const last=localStorage.getItem('tj:last'); if(last){ const {p,raised,goal,ts}=JSON.parse(last);
Â  Â  Â  Â  applyProgress(p); hud.raised.textContent=formatBRL(raised); hud.goal.textContent=formatBRL(goal);
Â  Â  Â  Â  hud.pct.textContent=(p*100).toFixed(1).replace('.',',')+'%'; hud.updated.textContent='Offline â€” Ãºltimo: '+new Date(ts).toLocaleString('pt-BR');
Â  Â  Â  }else if(hud.updated.textContent==='â€”'){ hud.updated.textContent='(Erro na planilha)' }
Â  Â  Â  return {ok:false};
Â  Â  }
Â  }

Â  const canon = s => (s||'').toString().toLowerCase()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .replace(/[^a-z0-9]+/g,' ').trim();

Â  async function fetchDonors(){
Â  Â  if(!CONFIG.donorsOn) {donors=[]; assignDonorsToBricks(); dbgDonors.textContent='desligado'; return;}
Â  Â  try{
Â  Â  Â  const base=`https://docs.google.com/spreadsheets/d/${(CONFIG.donorsSheetId||CONFIG.sheetId)}/gviz/tq`;
Â  Â  Â  const params=new URLSearchParams({tqx:'out:json',sheet:CONFIG.donorsSheet,range:CONFIG.donorsRange,t:Date.now()+''});
Â  Â  Â  const res=await fetch(`${base}?${params}`,{cache:'no-store'});Â 
Â  Â  Â  const txt=await res.text();
Â  Â  Â  const m=txt.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);Â 
Â  Â  Â  if (!m || !m[1]) { throw new Error('Invalid Gviz response format'); }
Â  Â  Â  const data=JSON.parse(m[1]);
Â  Â  Â  const cols=(data?.table?.cols||[]).map(c => (c.label||'').toString());
Â  Â  Â  const rows=data?.table?.rows||[];

Â  Â  Â  let header = cols;
Â  Â  Â  let headerFromRow = false;

Â  Â  Â  if (!header.some(h => (h||'').trim().length)){
Â  Â  Â  Â  const r0 = rows[0];
Â  Â  Â  Â  if (r0 && r0.c){
Â  Â  Â  Â  Â  header = r0.c.map(c => (c?.v ?? c?.f ?? '').toString());
Â  Â  Â  Â  Â  headerFromRow = true;
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  const wanted = canon(CONFIG.donorsHeader);
Â  Â  Â  const headerCanon = header.map(canon);

Â  Â  Â  let colIdx = headerCanon.findIndex(h => h === wanted);
Â  Â  Â  if (colIdx === -1) colIdx = headerCanon.findIndex(h => h.includes(wanted) || wanted.includes(h));

Â  Â  Â  const nameCandidates = ['nome','nome completo','name'];
Â  Â  Â  let nameIdx = headerCanon.findIndex(hc =>
Â  Â  Â  Â  nameCandidates.some(cand => hc === cand || hc.startsWith(cand + ' '))
Â  Â  Â  );
Â  Â  Â  if (nameIdx === -1) {
Â  Â  Â  Â  nameIdx = headerCanon.findIndex(hc =>
Â  Â  Â  Â  Â  /\b(nome|name)\b/.test(hc) && !/\b(email|e[- ]?mail|telefone|celular|whats|whatsapp)\b/.test(hc)
Â  Â  Â  Â  );
Â  Â  Â  }
Â  Â  Â  if (nameIdx < 0) nameIdx = -1;

Â  Â  Â  if (colIdx === -1){
Â  Â  Â  Â  donors=[];
Â  Â  Â  Â  dbgDonors.textContent='cabeÃ§alho nÃ£o encontrado';
Â  Â  Â  }else{
Â  Â  Â  Â  const startIdx = headerFromRow ? 1 : 0;
Â  Â  Â  Â  const out=[];
Â  Â  Â  Â  for (let i=startIdx;i<rows.length;i++){
Â  Â  Â  Â  Â  const r = rows[i]; if(!r || !r.c) continue;
Â  Â  Â  Â  Â  const cell = r.c[colIdx];
Â  Â  Â  Â  Â  const v = (cell?.v ?? cell?.f ?? '').toString().trim();
Â  Â  Â  Â  Â  if (v){
Â  Â  Â  Â  Â  Â  let name = '';
Â  Â  Â  Â  Â  Â  if (nameIdx >= 0 && r.c[nameIdx]){
Â  Â  Â  Â  Â  Â  Â  name = (r.c[nameIdx]?.v ?? r.c[nameIdx]?.f ?? '').toString().trim();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  name = (name || '').replace(/\s+/g,' ').trim();
Â  Â  Â  Â  Â  Â  out.push({ name, msg: v, value: 0 });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  donors = out;
Â  Â  Â  Â  dbgDonors.textContent = 'carregados: ' + donors.length;
Â  Â  Â  }

Â  Â  Â  assignDonorsToBricks();
Â  Â  Â  return {ok:true, count: donors.length};
Â  Â  }catch(e){
Â  Â  Â  console.warn('Doadores: falha ao ler',e);
Â  Â  Â  donors=[]; assignDonorsToBricks();
Â  Â  Â  dbgDonors.textContent='erro/permissÃ£o';
Â  Â  Â  return {ok:false};
Â  Â  }
Â  }

Â  /* ---------- Controles (UI) ---------- */
Â  function syncControls(){
Â  Â  optMascotOn.checked = CONFIG.mascot;
Â  Â  optMascotSrc.value = CONFIG.mascotSrc;
Â  Â  optMascotX.value = parseFloat(String(CONFIG.mascotX).replace('%','')) || 90;
Â  Â  optMascotY.value = parseFloat(String(CONFIG.mascotY).replace('%','')) || 75;
Â  Â  optDonorsOn.checked = CONFIG.donorsOn;
Â  Â  optNamesMode.value = CONFIG.namesMode;
Â  Â  optHudOn.checked = !CONFIG.hudOff;
Â  }
Â  function saveSettings(){ const copy={...CONFIG}; localStorage.setItem('tj:settings', JSON.stringify(copy)); }
Â  function applySettings(){
Â  Â  CONFIG.mascot = optMascotOn.checked;
Â  Â  CONFIG.mascotSrc = optMascotSrc.value;
Â  Â  CONFIG.mascotX = (optMascotX.value==='' ? '90' : optMascotX.value) + (String(optMascotX.value).includes('%')?'':'%');
Â  Â  CONFIG.mascotY = (optMascotY.value==='' ? '75'Â  : optMascotY.value) + (String(optMascotY.value).includes('%')?'':'%');
Â  Â  CONFIG.donorsOn = optDonorsOn.checked;
Â  Â  CONFIG.namesMode = optNamesMode.value;
Â  Â  CONFIG.hudOff = !optHudOn.checked;

Â  Â  effCols = undefined; effRows = undefined;

Â  Â  if(CONFIG.hudOff) hud.box.classList.add('hidden'); else hud.box.classList.remove('hidden');

Â  Â  setMascotByAnchor();
Â  Â  colorizeBricks();
Â  Â  layoutBricks();
Â  Â  fetchDonors();
Â  Â  saveSettings();
Â  }
Â  optMascotOn.onchange = applySettings;
Â  optMascotSrc.onchange = applySettings;
Â  optMascotX.oninput = ()=>{ applySettings(); };
Â  optMascotY.oninput = ()=>{ applySettings(); };
Â  optDonorsOn.onchange = ()=>{ applySettings(); };
Â  optNamesMode.onchange = applySettings;
Â  optHudOn.onchange = applySettings;

Â  let pollId = null;
Â  function startPolling() {
Â  Â  if (pollId) clearInterval(pollId);
Â  Â  pollId = setInterval(fetchProgress, CONFIG.pollMs);
Â  }

Â  btnRefresh.onclick = ()=> {
Â  Â  fetchProgress().then(()=>{
Â  Â  Â  btnRefresh.textContent = 'Atualizado âœ”';
Â  Â  Â  setTimeout(()=> btnRefresh.textContent='Atualizar agora', 1200);
Â  Â  });
Â  Â  fetchDonors();
Â  };

Â  btnSimulate.onclick = ()=> {
Â  Â  if (pollId) { clearInterval(pollId); pollId = null; }
Â  Â  const p = 1;
Â  Â  applyProgress(p);
Â  Â  if (lastGoalValue && lastGoalValue > 0) {
Â  Â  Â  hud.pct.textContent = '100,0%';
Â  Â  Â  tweenNumber(hud.raised, lastGoalValue, n=>formatBRL(n));
Â  Â  } else {
Â  Â  Â  hud.pct.textContent = '100,0%';
Â  Â  }
Â  Â  setTimeout(()=> startPolling(), 6000);
Â  };

Â  btnCopyLink.onclick = ()=>{
Â  Â  const u=new URL(location.href);
Â  Â  const params=new URLSearchParams();
Â  Â  // Apenas copia parÃ¢metros que ainda sÃ£o customizÃ¡veis
Â  Â  if(CONFIG.donorsOn) params.set('donors','1');
Â  Â  if(CONFIG.namesMode!==DEFAULTS.namesMode) params.set('names',CONFIG.namesMode);
Â  Â  if(CONFIG.hudOff) params.set('hud','0');
Â  Â  if(CONFIG.donorsSheetId!==DEFAULTS.donorsSheetId) params.set('donors_sheet_id', CONFIG.donorsSheetId);
Â  Â  if(CONFIG.donorsSheet!==DEFAULTS.donorsSheet)Â  Â params.set('donors_sheet', CONFIG.donorsSheet);
Â  Â  if(CONFIG.donorsHeader!==DEFAULTS.donorsHeader) params.set('donors_header', CONFIG.donorsHeader);
Â  Â  if (CONFIG.mascotX !== DEFAULTS.mascotX) params.set('mascot_x', CONFIG.mascotX);
Â  Â  if (CONFIG.mascotY !== DEFAULTS.mascotY) params.set('mascot_y', CONFIG.mascotY);
Â  Â  u.search = params.toString();
Â  Â  navigator.clipboard.writeText(u.toString()).then(()=>{btnCopyLink.textContent='Link copiado!';setTimeout(()=>btnCopyLink.textContent='Copiar link com estas opÃ§Ãµes',1800)});
Â  };
Â  btnReset.onclick = ()=>{
Â  Â  Object.assign(CONFIG, DEFAULTS);
Â  Â  syncControls(); applySettings();
Â  };

Â  fab.onclick = ()=> drawer.classList.add('open');
Â  closeDrawer.onclick = ()=> drawer.classList.remove('open');

Â  if (qs.get('debug') !== '1') {
Â  Â  document.querySelectorAll('.debug-row').forEach(el => el.style.display='none');
Â  }

Â  /* ---------- inicializaÃ§Ã£o ---------- */
Â  document.body.classList.add('no-anim');

Â  syncControls();
Â  if(CONFIG.hudOff) hud.box.classList.add('hidden');

Â  const ro=new ResizeObserver(()=>{ layoutBricks(); if(CONFIG.mascot) setMascotByAnchor(); }); ro.observe(gauge);
Â  window.addEventListener('orientationchange',()=>setTimeout(layoutBricks,150));

Â  loadLogo(CONFIG.logo).then(()=>{ensureAspectFromLogo(); layoutBricks(); setMascotByAnchor();});
Â  fetchDonors();
Â  fetchProgress().then(()=> startPolling());
})();
</script>
</body>
</html>
Limpe e consolide o cÃ³digo para mim, sem mudar nada a mais que nÃ£o seja estritamente necessÃ¡rio.
