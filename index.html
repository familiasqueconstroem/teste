<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tijolômetro — Cada Tijolo Conta</title>
<link rel="preconnect" href="https://docs.google.com"><link rel="dns-prefetch" href="https://docs.google.com">
<meta name="theme-color" content="#8B1E1E">
<style>
:root{
  --bg:#FFFAF5; --grout:#E5DBD1; --grid:#CDBFB3; --brick-bg-color:#a35a41;
  --pad:0px; --joint:0.8px; --ghost:0.12; --panel-max-width:1600px;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;display:flex;align-items:center;justify-content:center;padding:12px}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px) scale(.99)}to{opacity:1;transform:none}}
.panel{width:min(var(--panel-max-width),98vw);background:#fff;border-radius:20px;box-shadow:0 8px 30px rgba(0,0,0,.08);
  padding:16px;display:flex;flex-direction:column;gap:16px;animation:fadeIn .5s ease-out}
.gauge{position:relative;width:100%;border-radius:14px;overflow:hidden;background:#F7EFE7;min-height:300px}
.ghost-logo{position:absolute;inset:var(--pad);width:calc(100% - (var(--pad) * 2));height:calc(100% - (var(--pad) * 2));
  margin:auto;object-fit:contain;opacity:var(--ghost);filter:grayscale(1) sepia(1) brightness(1.5)}
.bricks-bg{position:absolute;inset:0}
.mask-layer{position:absolute;inset:0;background:transparent;--mask:url('logo.png');
  -webkit-mask-image:var(--mask);mask-image:var(--mask);-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;
  -webkit-mask-position:center;mask-position:center;-webkit-mask-size:contain;mask-size:contain}
.bricks{position:relative;width:100%;height:100%}
.brick{position:absolute;background:var(--grout);border-radius:2px;overflow:hidden;box-shadow: inset 0 0 0 var(--joint) var(--grid)}
.brick .fill{position:absolute;inset:0;width:0%;height:100%;background:var(--brick-bg-color);transition:width .35s ease}
.brick.filled .fill{width:100%}

/* sem animação no primeiro paint (evita “linha voadora”) */
.no-anim .brick .fill{ transition:none !important; }

.hud{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;padding:10px;border:1px solid #eee;border-radius:12px;background:#fdfdfd;font-variant-numeric:tabular-nums;align-items:center}
.hud .item{display:flex;flex-direction:column;gap:2px}
.hud .label{font-size:12px;color:#666}.hud .value{font-size:20px;font-weight:800}.hud .pct{font-weight:900}
.hud .updated{justify-self:end;font-size:11px;color:#777;text-align:right}
@media (max-width:740px){.hud{grid-template-columns:repeat(2,minmax(0,1fr))}.hud .updated{grid-column:1/-1;justify-self:start;text-align:left}}
.alert{position:absolute;left:14px;top:14px;background:#fff3cd;border:1px solid #ffe69c;color:#664d03;padding:8px 10px;border-radius:10px;font-size:12px;display:none}
.alert b{display:block;margin-bottom:4px}

/* Mascote PNG (opcional) */
.mascot{position:absolute;left:0;top:0;z-index:20;pointer-events:none;display:none;transition:transform .35s cubic-bezier(.2,.8,.2,1)}
.mascot img{display:block;width:110px;height:auto}
.carry-brick,.fx-brick{position:absolute;width:26px;height:14px;background:var(--brick-bg-color);border-radius:2px;box-shadow: inset 0 0 0 1px #8b6f5c}

/* Tooltip simples */
#tip{
  position:fixed; z-index:9990; display:none;
  background:#fff; color:#111; border:1px solid #ddd; padding:8px 10px; border-radius:10px;
  box-shadow:0 8px 24px rgba(0,0,0,.18); max-width:240px; font:14px/1.3 system-ui;
}
#tip .mini{ font-size:12px; color:#666; margin-top:4px }

body.embed{background:transparent}.hud.hidden{display:none}

/* -------- Painel de Controles -------- */
.fab{position:fixed;right:18px;bottom:18px;z-index:9998;width:54px;height:54px;border-radius:50%;
  background:#0A4AA6;color:#fff;display:flex;align-items:center;justify-content:center;
  box-shadow:0 12px 28px rgba(0,0,0,.18);cursor:pointer;font-size:22px}
.fab:active{transform:scale(.98)}
.drawer{position:fixed;inset:0 0 0 auto;width:340px;max-width:92vw;background:#fff;border-left:1px solid #eee;box-shadow:-16px 0 40px rgba(0,0,0,.18);
  transform:translateX(105%);transition:transform .28s ease;z-index:9999;display:flex;flex-direction:column}
.drawer.open{transform:none}
.drawer .head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eee}
.drawer .body{padding:12px 16px 18px;overflow:auto}
.drawer h4{margin:14px 0 8px 0}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.row label{font-size:13px;color:#333}
select,input[type="text"],input[type="number"]{font:inherit;padding:6px 8px;border:1px solid #ddd;border-radius:8px;background:#fff}
.switch{appearance:none;width:42px;height:24px;background:#ddd;border-radius:999px;position:relative;outline:none;cursor:pointer}
.switch:checked{background:#0A4AA6}
.switch::after{content:"";position:absolute;left:2px;top:2px;width:20px;height:20px;border-radius:999px;background:#fff;transition:left .18s}
.switch:checked::after{left:20px}
.slider{width:100%}
.btn{padding:8px 12px;border-radius:10px;border:1px solid #ddd;background:#fafafa;cursor:pointer}
.btn.primary{background:#0A4AA6;color:#fff;border-color:#0A4AA6}
.small{font-size:12px;color:#666}
</style>
</head>
<body>
  <div class="panel">
    <div class="gauge" id="gauge">
      <div class="alert" id="logoAlert"><b>Logo não carregou</b> — verifique o arquivo logo.png.</div>

      <img class="ghost-logo" id="ghostLogo" alt="logo" />

      <!-- Mascote PNG -->
      <div class="mascot" id="mascot" aria-hidden="true">
        <img id="mascotImg" src="Tio_Jolinho_tijolo.png" alt="Tio Jolinho">
        <div class="carry-brick" id="carryBrick" style="left:64px;top:58px"></div>
      </div>

      <div class="bricks-bg" id="bricksBg"></div>
      <div class="mask-layer" id="mask"><div class="bricks" id="bricksFg"></div></div>
    </div>

    <div class="hud" id="hud">
      <div class="item"><span class="label">Arrecadado</span><span class="value" id="hudRaised">R$ 0,00</span></div>
      <div class="item"><span class="label" id="hudGoalLabel">Meta</span><span class="value" id="hudGoal">R$ 0,00</span></div>
      <div class="item"><span class="label">Progresso</span><span class="value pct" id="hudPct">0%</span></div>
      <div class="updated" id="hudUpdated">—</div>
    </div>
  </div>

  <!-- Tooltip -->
  <div id="tip"></div>

  <!-- FAB e Drawer -->
  <button class="fab" id="fab" title="Opções">⚙️</button>
  <aside class="drawer" id="drawer" aria-label="Controles do Tijolômetro">
    <div class="head">
      <strong>Opções do Tijolômetro</strong>
      <button class="btn" id="closeDrawer">Fechar</button>
    </div>
    <div class="body">
      <h4>Visual</h4>
      <div class="row">
        <label>Paleta:</label>
        <select id="optPalette">
          <option value="brand3">Brand 3 (azul/amarelo/vinho)</option>
          <option value="brand2">Brand 2 (azul/amarelo)</option>
        </select>
      </div>
      <div class="row" style="margin-top:8px">
        <label style="min-width:110px">Tamanho do tijolo:</label>
        <input id="optBrickPx" class="slider" type="range" min="8" max="22" step="1">
        <label><input id="optAutoDensity" type="checkbox"> Auto</label>
      </div>

      <h4>Mascote</h4>
      <div class="row">
        <label>Mostrar:</label><input id="optMascotOn" class="switch" type="checkbox" checked>
      </div>
      <div class="row" style="margin-top:8px">
        <label>Imagem:</label>
        <select id="optMascotSrc">
          <option>Tio_Jolinho_tijolo.png</option>
          <option>Tio_Jolinho_carrinho.png</option>
          <option>Tio_Jolinho_martelo.png</option>
          <option>Sr._Construtino_colher.png</option>
          <option>Lumininha_trena.png</option>
        </select>
      </div>

      <h4>Doadores</h4>
      <div class="row">
        <label>Tooltip de doadores:</label><input id="optDonorsOn" class="switch" type="checkbox">
      </div>
      <div class="row" style="margin-top:8px">
        <label>Exibir nome:</label>
        <select id="optNamesMode">
          <option value="first">Nome curto</option>
          <option value="full">Nome completo</option>
          <option value="off">Ocultar</option>
        </select>
      </div>

      <h4>HUD</h4>
      <div class="row">
        <label>Exibir painel:</label><input id="optHudOn" class="switch" type="checkbox" checked>
      </div>

      <h4>Ações</h4>
      <div class="row">
        <button class="btn" id="btnRefresh">Atualizar agora</button>
        <button class="btn" id="btnSimulate">Simular +2%</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="btnCopyLink">Copiar link com estas opções</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnReset">Restaurar padrão</button>
        <span class="small">Preferências são salvas no seu navegador.</span>
      </div>
    </div>
  </aside>

<script>
(function(){
  /* ---------- parâmetros e defaults ---------- */
  const qs=new URLSearchParams(location.search);
  const DEFAULTS={
    // Planilha do PAINEL (esta já estava “certinha” na sua versão)
    sheetId:'1-_J2DwVSn7LULB55YVPCHQsQ-PRfZYt8oDJhepdXYFY',
    sheetName:'Tijolometro', range:'A1:D10',

    // Doadores a partir do Forms
    donorsOn:false,
    donorsSheetId:'1CbyqJL0lpYAzxBXRw9dvUh5DHh50imJOw5AUjVALy8I',
    donorsSheet:'TIJOLO_Respostas',
    donorsRange:'I2:I10000',
    namesMode:'first',

    logo:'logo.png', cols:120, rows:72, brickPx:0, targetBricks:0, gap:1,
    pollMs:30000, pad:0, grout:'', joint:'', ghost:'', palette:'brand3',
    embed:false, hudOff:false,
    mascot:true, mascotSrc:'Tio_Jolinho_tijolo.png', respectMotion:false
  };
  function loadSaved(){ try{ return JSON.parse(localStorage.getItem('tj:settings')||'{}'); }catch{return{}} }
  const SAVED=loadSaved();

  // merge: URL > saved > defaults
  const CONFIG={...DEFAULTS,...SAVED,
    ...Object.fromEntries([...qs.entries()].map(([k,v])=>{
      if(['brick_px','cols','rows','gap','poll_ms','pad','target_bricks'].includes(k)) return [toKey(k), +v];
      if(['donors','embed','hud','mascot','respect_motion'].includes(k)) return [toKey(k), v==='1'];
      return [toKey(k), v];
    }))}
  function toKey(k){return ({
    'sheet_id':'sheetId','sheet':'sheetName','range':'range',
    'donors':'donorsOn','donors_sheet':'donorsSheet','donors_range':'donorsRange','donors_sheet_id':'donorsSheetId','names':'namesMode',
    'logo':'logo','cols':'cols','rows':'rows','brick_px':'brickPx','gap':'gap','poll_ms':'pollMs','pad':'pad','palette':'palette',
    'embed':'embed','hud':'hudOn','target_bricks':'targetBricks','mascot':'mascot','mascot_src':'mascotSrc','respect_motion':'respectMotion'
  }[k]||k)}

  // aplicar variáveis de estilo opcionais
  if (CONFIG.pad) document.documentElement.style.setProperty('--pad', CONFIG.pad+'px');
  if (CONFIG.grout) document.documentElement.style.setProperty('--grout', CONFIG.grout);
  if (CONFIG.joint) document.documentElement.style.setProperty('--joint', CONFIG.joint+'px');
  if (CONFIG.ghost) document.documentElement.style.setProperty('--ghost', CONFIG.ghost);
  if (CONFIG.embed) document.body.classList.add('embed');

  /* ---------- elementos ---------- */
  const gauge=document.getElementById('gauge'), maskEl=document.getElementById('mask'),
        ghostEl=document.getElementById('ghostLogo'), bricksFgEl=document.getElementById('bricksFg'),
        bricksBgEl=document.getElementById('bricksBg'), alertBox=document.getElementById('logoAlert');
  const hud={raised:document.getElementById('hudRaised'),goal:document.getElementById('hudGoal'),
             pct:document.getElementById('hudPct'),updated:document.getElementById('hudUpdated'),
             goalLabel:document.getElementById('hudGoalLabel'), box:document.getElementById('hud')};
  const mascotBox=document.getElementById('mascot'), mascotImg=document.getElementById('mascotImg');
  const tip=document.getElementById('tip');

  // controls
  const fab=document.getElementById('fab'), drawer=document.getElementById('drawer'),
        closeDrawer=document.getElementById('closeDrawer'),
        optPalette=document.getElementById('optPalette'),
        optBrickPx=document.getElementById('optBrickPx'),
        optAutoDensity=document.getElementById('optAutoDensity'),
        optMascotOn=document.getElementById('optMascotOn'),
        optMascotSrc=document.getElementById('optMascotSrc'),
        optDonorsOn=document.getElementById('optDonorsOn'),
        optNamesMode=document.getElementById('optNamesMode'),
        optHudOn=document.getElementById('optHudOn'),
        btnRefresh=document.getElementById('btnRefresh'),
        btnSimulate=document.getElementById('btnSimulate'),
        btnCopyLink=document.getElementById('btnCopyLink'),
        btnReset=document.getElementById('btnReset');

  /* ---------- estado de desenho ---------- */
  const paintCanvas=document.createElement('canvas');
  const pctx=paintCanvas.getContext('2d',{willReadFrequently:true});
  let logoImg=null,aspectSet=false,bricksFg=[],bricksBg=[],effCols,effRows,lastProgress=0,lastFilled=0,donors=[];
  let firstApplyDone=false; // <- para tirar animações no primeiro paint

  function setMaskImage(url){ maskEl.style.setProperty('--mask', `url('${url}')`); }
  function formatBRL(n){ try{return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(n);}catch{return 'R$ '+Number(n||0).toLocaleString('pt-BR');} }
  function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
  function tweenNumber(el,to,fmt,ms=600){ const from=Number((el.textContent||'0').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',','.'))||0;
    const t0=performance.now(); (function f(t){const k=Math.min(1,(t-t0)/ms);el.textContent=fmt(from+(to-from)*k); if(k<1)requestAnimationFrame(f)})(t0); }
  function firstName(n){ if(!n) return ''; const p=n.trim().split(/\s+/); return p[0]+(p[1]?' '+p[1][0]+'.':''); }
  function formatName(n){ if(CONFIG.namesMode==='off')return 'Doação recebida'; if(CONFIG.namesMode==='full')return n||'Doação recebida'; return firstName(n||''); }

  function loadLogo(src){ return new Promise(res=>{ const im=new Image();
    im.onload=()=>{logoImg=im;ghostEl.src=im.src;setMaskImage(im.src);alertBox.style.display='none';res(true)};
    im.onerror=()=>{alertBox.style.display='block';res(false)};
    im.src=src+(src.includes('?')?'&':'?')+'t='+Date.now();
  })}

  function ensureAspectFromLogo(){ if(aspectSet||!logoImg) return; const ar=logoImg.naturalWidth/logoImg.naturalHeight; if(ar>0) gauge.style.aspectRatio=`${ar} / 1`; aspectSet=true; }

  const PALETTES={brand2:['#0A4AA6','#F2C035'],brand3:['#0A4AA6','#F2C035','#8B1E1E']};
  const hexToRgb=h=>{const n=parseInt(h.replace('#',''),16);return{r:(n>>16)&255,g:(n>>8)&255,b:n&255}};
  const dist2=(c1,c2)=>{const dr=c1.r-c2.r,dg=c1.g-c2.g,db=c1.b-c2.b;return dr*dr+dg*dg+db*db};
  function mapToPalette(r,g,b,name){const set=PALETTES[name];if(!set)return`rgb(${r},${g},${b})`;let best=set[0],bestD=Infinity,c1={r,g,b};
    for(const h of set){const c2=hexToRgb(h);const d=dist2(c1,c2);if(d<bestD){bestD=d;best=h}}return best}
  const makeSampler=(data,W,H)=>(x,y)=>{const xi=Math.max(0,Math.min(W-1,Math.round(x))), yi=Math.max(0,Math.min(H-1,Math.round(y))), i=(yi*W+xi)*4; return [data[i],data[i+1],data[i+2],data[i+3]]};
  const median=a=>{const b=a.slice().sort((m,n)=>m-n);return b[Math.floor(b.length/2)]};

  function colorizeBricks(){
    if(!logoImg) return; const W=bricksFgEl.clientWidth,H=bricksFgEl.clientHeight;if(!W||!H) return;
    paintCanvas.width=W;paintCanvas.height=H;pctx.clearRect(0,0,W,H);
    const ar=logoImg.naturalWidth/logoImg.naturalHeight;let dw=W,dh=W/ar;if(dh>H){dh=H;dw=H*ar}
    const dx=(W-dw)/2,dy=(H-dh)/2;pctx.drawImage(logoImg,dx,dy,dw,dh);
    const buf=pctx.getImageData(0,0,W,H).data;const samp=makeSampler(buf,W,H);
    for(let i=0;i<bricksFg.length;i++){
      const bFg=bricksFg[i],bBg=bricksBg[i];const x=bFg._x,y=bFg._y,w=bFg._w,h=bFg._h;
      const pts=[[x+w/2,y+h/2],[x+1,y+1],[x+w-2,y+1],[x+1,y+h-2],[x+w-2,y+h-2],[x+w/2,y+1],[x+w/2,y+h-2],[x+1,y+h/2],[x+w-2,y+h/2]];
      const rs=[],gs=[],bs=[],as=[];for(const [px,py] of pts){const d=samp(px,py);rs.push(d[0]);gs.push(d[1]);bs.push(d[2]);as.push(d[3])}
      const A=median(as);const fg=bFg.querySelector('.fill'), bg=bBg.querySelector('.fill');
      if(A<100){fg.style.background='transparent';bg.style.opacity='1'}
      else{const r=median(rs),g=median(gs),b=median(bs);fg.style.background=mapToPalette(r,g,b,CONFIG.palette);bg.style.opacity='0'}
    }
  }

  let _orderFg=[],_orderBg=[];
  function buildOrder(rows,cols){const of=[],ob=[];for(let r=rows-1;r>=0;r--){for(let c=0;c<cols;c++){const i=r*cols+c;of.push(bricksFg[i]);ob.push(bricksBg[i])}} _orderFg=of;_orderBg=ob}
  function layoutBricks(){
    ensureAspectFromLogo(); const W=bricksFgEl.clientWidth,H=bricksFgEl.clientHeight;if(!W||!H) return;
    if(CONFIG.brickPx>0){ const bw=CONFIG.brickPx,bh=Math.round(bw*0.6); effCols=Math.max(20,Math.floor((W-CONFIG.gap)/(bw+CONFIG.gap))); effRows=Math.max(12,Math.floor((H-CONFIG.gap)/(bh+CONFIG.gap))); }
    else if(CONFIG.targetBricks>0){const ar=W/H;const rows=Math.max(12,Math.round(Math.sqrt(CONFIG.targetBricks/(ar*1.0))));const cols=Math.max(20,Math.round(rows*ar));effCols=cols;effRows=rows}
    const cols=(typeof effCols==='number'&&effCols>0)?effCols:CONFIG.cols;
    const rows=(typeof effRows==='number'&&effRows>0)?effRows:CONFIG.rows;
    const gap=CONFIG.gap; let brickW=Math.floor((W-(cols+1)*gap)/cols); if(brickW<2)brickW=2;
    let offset=Math.floor(brickW/2); let gridWEven=cols*brickW+(cols+1)*gap; let gridWOdd=gridWEven+offset;
    if(gridWOdd>W){const extra=gridWOdd-W;const reduce=Math.ceil(extra/cols);brickW=Math.max(2,brickW-reduce);offset=Math.floor(brickW/2);gridWEven=cols*brickW+(cols+1)*gap;gridWOdd=gridWEven+offset}
    const brickH=Math.max(2,Math.floor((H-(rows+1)*gap)/rows)); const gridWMax=Math.max(gridWEven,gridWOdd); const startXBase=Math.max(gap,Math.floor((W-gridWMax)/2)+gap);
    const total=rows*cols;
    if(bricksFg.length!==total){
      bricksFgEl.innerHTML='';bricksBgEl.innerHTML='';bricksFg=[];bricksBg=[];
      const fragFg=document.createDocumentFragment(),fragBg=document.createDocumentFragment();
      for(let i=0;i<total;i++){ const f=document.createElement('div');f.className='brick';f.dataset.idx=i;f.appendChild(document.createElement('div')).className='fill';fragFg.appendChild(f);bricksFg.push(f);
        const b=document.createElement('div');b.className='brick';b.appendChild(document.createElement('div')).className='fill';fragBg.appendChild(b);bricksBg.push(b); }
      bricksFgEl.appendChild(fragFg); bricksBgEl.appendChild(fragBg);
    }
    let idx=0; for(let r=0;r<rows;r++){ const startX=startXBase+(r%2?offset:0);
      for(let c=0;c<cols;c++){ const x=startX+c*(brickW+gap),y=gap+r*(brickH+gap);
        const F=bricksFg[idx]; F.style.cssText=`left:${x}px;top:${y}px;width:${brickW}px;height:${brickH}px;`; F._x=x;F._y=y;F._w=brickW;F._h=brickH;
        const B=bricksBg[idx]; B.style.cssText=`left:${x}px;top:${y}px;width:${brickW}px;height:${brickH}px;`; idx++; } }
    buildOrder(rows,cols); colorizeBricks(); applyProgress(lastProgress); if(CONFIG.mascot) placeMascot();
  }

  function applyProgress(p){
    p=Math.max(0,Math.min(1,p||0)); lastProgress=p;

    // Desliga animações no primeiro paint
    if(!firstApplyDone){ document.body.classList.add('no-anim'); }

    const of=_orderFg,ob=_orderBg,total=of.length; if(!total) return;
    const filled=Math.floor(p*total), frac=(p*total)-filled;
    for(let i=0;i<total;i++){ const fF=of[i].querySelector('.fill'), fB=ob[i].querySelector('.fill'); of[i].classList.remove('filled','partial'); fF.style.width='0%'; ob[i].classList.remove('filled','partial'); fB.style.width='0%';
      if(i<filled){ of[i].classList.add('filled'); fF.style.width='100%'; ob[i].classList.add('filled'); fB.style.width='100%'; } }
    if(filled<total){ const fF=of[filled].querySelector('.fill'), fB=ob[filled].querySelector('.fill'); const percent=Math.round(frac*100)+'%'; of[filled].classList.add('partial'); fF.style.width=percent; ob[filled].classList.add('partial'); fB.style.width=percent; }

    // Reativa animações só depois do primeiro apply
    if(!firstApplyDone){
      firstApplyDone=true;
      requestAnimationFrame(()=> document.body.classList.remove('no-anim'));
    }

    if (CONFIG.mascot && filled > lastFilled){ stackBrickTo(of[filled-1]||of[0]); lastFilled=filled; }
  }

  function moveMascotTo(brick){ if(!brick) return; const gR=gauge.getBoundingClientRect(), bR=brick.getBoundingClientRect();
    const x=bR.left-gR.left + bR.width/2 - 55; const y=bR.top-gR.top - 60; mascotBox.style.transform=`translate(${Math.round(x)}px,${Math.round(y)}px)` }
  function stackBrickTo(brick){
    if(!brick || !firstApplyDone) return; // não anima durante 1º paint
    const fx=document.createElement('div');fx.className='fx-brick';gauge.appendChild(fx);
    const gR=gauge.getBoundingClientRect(), bR=brick.getBoundingClientRect(), mR=mascotBox.getBoundingClientRect();
    const sx=mR.left-gR.left+76, sy=mR.top-gR.top+78, tx=bR.left-gR.left + bR.width/2 -13, ty=bR.top-gR.top + bR.height/2 -7;
    fx.style.left=sx+'px'; fx.style.top=sy+'px'; fx.style.transition='transform .45s cubic-bezier(.2,.8,.2,1), opacity .45s';
    requestAnimationFrame(()=>{ fx.style.transform=`translate(${Math.round(tx-sx)}px,${Math.round(ty-sy)}px) scale(1.05)` });
    setTimeout(()=>{ fx.style.opacity='0'; setTimeout(()=>fx.remove(),220)},460); moveMascotTo(brick);
  }
  function placeMascot(){
    if(!CONFIG.mascot) {mascotBox.style.display='none';return}
    if(CONFIG.respectMotion && matchMedia('(prefers-reduced-motion: reduce)').matches){ mascotBox.style.display='none'; return }
    mascotImg.src=CONFIG.mascotSrc; mascotBox.style.display='block';
    const idx=Math.min(_orderFg.length-1,Math.floor(lastProgress*_orderFg.length)); moveMascotTo(_orderFg[idx]);
  }

  // Tooltips de doadores (Forms)
  let tipTimer=null;
  bricksFgEl.addEventListener('click', onBrickTap, {passive:true});
  bricksFgEl.addEventListener('touchstart', onBrickTap, {passive:true});
  function onBrickTap(e){
    const brick=e.target.closest('.brick'); if(!brick||!bricksFgEl.contains(brick)) return;
    const donor=brick._donor;
    const r=brick.getBoundingClientRect();
    const donorTitle = (donor && donor.name)
      ? `<b>${formatName(donor.name)}</b>` : `<b>Famílias que Constroem</b>`;
    const html = CONFIG.donorsOn && donor
      ? `${donorTitle}${donor.msg?`<div>${donor.msg}</div>`:''}<div class="mini">${donor.value?('Doou '+formatBRL(donor.value)):'Obrigado!'}</div>`
      : `<b>Obrigado!</b><div class="mini">Cada tijolo conta 💛</div>`;
    tip.innerHTML=html; tip.style.display='block';
    const left=Math.min(Math.max(8,r.left+r.width/2), innerWidth-240); const top=Math.max(8,r.top-12);
    tip.style.left=left+'px'; tip.style.top=top+'px';
    clearTimeout(tipTimer); tipTimer=setTimeout(()=> tip.style.display='none', 3000);
    if(CONFIG.mascot){ moveMascotTo(brick); stackBrickTo(brick); }
  }

  // Parser de datas da planilha (mantido)
  function parseDateCell(cell){
    let v=(cell&&typeof cell==='object'&&'v'in cell)?cell.v:cell;
    if(v&&typeof v==='object'){ if('f'in v&&typeof v.f==='string')return parseDateCell(v.f); if('v'in v) return parseDateCell(v.v); }
    if(!v) return null;
    if(typeof v==='string'){
      const gv=v.match(/Date\((\d+),\s*(\d+),\s*(\d+)/i); if(gv) return new Date(+gv[1],+gv[2],+gv[3]);
      const iso=v.match(/^(\d{4})[-\/.](\d{1,2})[-\/.](\d{1,2})$/); if(iso) return new Date(+iso[1],+iso[2]-1,+iso[3]);
      const br=v.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/); if(br){const d=+br[1],m=+br[2],y=+br[3]<100?2000+ +br[3]:+br[3];return new Date(y,m-1,d)}
      return null;
    }
    if(typeof v==='number'){const base=Date.UTC(1899,11,30);return new Date(base+v*86400*1000)}
    return null;
  }

  // === ATENÇÃO ===
  // fetchProgress() é a MESMA lógica que você já usava. Não alterei a forma de buscar valores.
  async function fetchProgress(){
    const base=`https://docs.google.com/spreadsheets/d/${CONFIG.sheetId}/gviz/tq`;
    const params=new URLSearchParams({tqx:'out:json',sheet:CONFIG.sheetName,range:CONFIG.range,t:Date.now()+''});
    try{
      const res=await fetch(`${base}?${params}`,{cache:'no-store'}); const txt=await res.text();
      const m=txt.match(/google\.visualization\.Query\.setResponse\((.*)\);/s); const data=JSON.parse(m[1]); const rows=data.table.rows||[];
      let raised=0; const campaigns=[];
      for(const r of rows){
        const label=r.c?.[0]?.v?.toString().trim(); if(!label) continue;
        const value=Number(r.c?.[1]?.v || r.c?.[1]?.f || 0);
        if(label.toLowerCase()==='arrecadado'){ raised=Number(value||0); continue; }
        const start=parseDateCell(r.c?.[2]); const end=parseDateCell(r.c?.[3]);
        campaigns.push({label,goal:Number(value||0),start,end});
      }
      const today=new Date(); today.setHours(0,0,0,0);
      let active=campaigns.find(c=>c.start&&c.end&&today>=c.start&&today<=c.end);
      if(!active) active=campaigns.find(c=>c.goal>0) || {label:'Meta',goal:0};
      const goal=Number(active.goal||0);
      const pRaw=goal>0 ? (raised/goal) : 0; const p=Math.max(0,Math.min(1,pRaw));

      applyProgress(p);
      tweenNumber(hud.raised, raised, n=>formatBRL(n)); tweenNumber(hud.goal, goal, n=>formatBRL(n));
      hud.goalLabel.textContent=active.label||'Meta';
      hud.pct.textContent=(pRaw*100).toFixed(1).replace('.',',')+'%';
      hud.updated.textContent='Atualizado em '+new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});

      try{localStorage.setItem('tj:last',JSON.stringify({p,raised,goal,ts:Date.now()}));}catch{}
    }catch(e){
      console.error('Erro ao buscar planilha:',e);
      const last=localStorage.getItem('tj:last'); if(last){ const {p,raised,goal,ts}=JSON.parse(last);
        applyProgress(p); hud.raised.textContent=formatBRL(raised); hud.goal.textContent=formatBRL(goal);
        hud.pct.textContent=(p*100).toFixed(1).replace('.',',')+'%'; hud.updated.textContent='Offline — último: '+new Date(ts).toLocaleString('pt-BR');
      }else if(hud.updated.textContent==='—'){ hud.updated.textContent='(Erro na planilha)' }
    }
  }

  // Busca doadores (Forms: planilha/aba/coluna I)
  async function fetchDonors(){
    if(!CONFIG.donorsOn) {donors=[]; return;}
    try{
      const base=`https://docs.google.com/spreadsheets/d/${(CONFIG.donorsSheetId||CONFIG.sheetId)}/gviz/tq`;
      const params=new URLSearchParams({tqx:'out:json',sheet:CONFIG.donorsSheet,range:CONFIG.donorsRange,t:Date.now()+''});
      const res=await fetch(`${base}?${params}`,{cache:'no-store'}); const txt=await res.text();
      const m=txt.match(/google\.visualization\.Query\.setResponse\((.*)\);/s); const data=JSON.parse(m[1]);
      donors=(data.table.rows||[])
        .map(r=> ((r.c?.[0]?.v||'').toString().trim()))
        .filter(s=>s.length>0)
        .map(s=>({ name:'', msg:s, value:0 }));
      // vincula ciclicamente aos tijolos (só para tooltip)
      const of=_orderFg;
      for(let i=0;i<of.length;i++){ of[i]._donor = donors.length? donors[i % donors.length] : null; }
    }catch(e){ console.warn('Doadores: falha ao ler',e); donors=[]; }
  }

  /* ---------- Controles (UI) ---------- */
  function syncControls(){
    optPalette.value = CONFIG.palette;
    optAutoDensity.checked = CONFIG.brickPx===0;
    optBrickPx.value = CONFIG.brickPx || 14;
    optBrickPx.disabled = optAutoDensity.checked;
    optMascotOn.checked = CONFIG.mascot;
    optMascotSrc.value = CONFIG.mascotSrc;
    optDonorsOn.checked = CONFIG.donorsOn;
    optNamesMode.value = CONFIG.namesMode;
    optHudOn.checked = !CONFIG.hudOff;
  }
  function saveSettings(){ const copy={...CONFIG}; localStorage.setItem('tj:settings', JSON.stringify(copy)); }
  function applySettings(){
    // visual
    CONFIG.palette = optPalette.value;
    CONFIG.brickPx = optAutoDensity.checked ? 0 : Number(optBrickPx.value);
    CONFIG.mascot = optMascotOn.checked;
    CONFIG.mascotSrc = optMascotSrc.value;
    CONFIG.donorsOn = optDonorsOn.checked;
    CONFIG.namesMode = optNamesMode.value;
    CONFIG.hudOff = !optHudOn.checked;
    // aplicar HUD/mascote
    if(CONFIG.hudOff) hud.box.classList.add('hidden'); else hud.box.classList.remove('hidden');
    placeMascot();
    // redesenho + doadores
    colorizeBricks(); layoutBricks();
    fetchDonors();
    saveSettings();
  }
  optPalette.onchange = applySettings;
  optBrickPx.oninput = ()=>{ if(!optAutoDensity.checked) applySettings(); };
  optAutoDensity.onchange = ()=>{ optBrickPx.disabled = optAutoDensity.checked; applySettings(); };
  optMascotOn.onchange = applySettings;
  optMascotSrc.onchange = applySettings;
  optDonorsOn.onchange = ()=>{ applySettings(); };
  optNamesMode.onchange = applySettings;
  optHudOn.onchange = applySettings;

  btnRefresh.onclick = ()=> fetchProgress();
  btnSimulate.onclick = ()=> applyProgress(Math.min(1,lastProgress+0.02));
  btnCopyLink.onclick = ()=>{
    const u=new URL(location.href);
    const params=new URLSearchParams();
    if(CONFIG.palette!==DEFAULTS.palette) params.set('palette',CONFIG.palette);
    if(CONFIG.brickPx!==0) params.set('brick_px',CONFIG.brickPx);
    if(!CONFIG.mascot) params.set('mascot','0'); else if(CONFIG.mascotSrc!==DEFAULTS.mascotSrc) params.set('mascot_src',CONFIG.mascotSrc);
    if(CONFIG.donorsOn) params.set('donors','1');
    if(CONFIG.namesMode!==DEFAULTS.namesMode) params.set('names',CONFIG.namesMode);
    if(CONFIG.hudOff) params.set('hud','0');
    // incluir origem dos doadores se não for o default
    if(CONFIG.donorsSheetId!==DEFAULTS.donorsSheetId) params.set('donors_sheet_id', CONFIG.donorsSheetId);
    if(CONFIG.donorsSheet!==DEFAULTS.donorsSheet)   params.set('donors_sheet', CONFIG.donorsSheet);
    if(CONFIG.donorsRange!==DEFAULTS.donorsRange)   params.set('donors_range', CONFIG.donorsRange);
    u.search = params.toString();
    navigator.clipboard.writeText(u.toString()).then(()=>{btnCopyLink.textContent='Link copiado!';setTimeout(()=>btnCopyLink.textContent='Copiar link com estas opções',1800)});
  };
  btnReset.onclick = ()=>{
    Object.assign(CONFIG, DEFAULTS);
    syncControls(); applySettings();
  };

  fab.onclick = ()=> drawer.classList.add('open');
  closeDrawer.onclick = ()=> drawer.classList.remove('open');

  /* ---------- inicialização ---------- */
  // garante sem animação no 1º paint
  document.body.classList.add('no-anim');

  syncControls();
  if(CONFIG.hudOff) hud.box.classList.add('hidden');

  const ro=new ResizeObserver(()=>layoutBricks()); ro.observe(gauge);
  window.addEventListener('orientationchange',()=>setTimeout(layoutBricks,150));

  loadLogo(CONFIG.logo).then(()=>{ensureAspectFromLogo(); layoutBricks();});
  fetchDonors();            // lê doadores do Forms (se ligado)
  fetchProgress();          // mantém sua lógica original para valores
  setInterval(fetchProgress, CONFIG.pollMs);
})();
</script>
</body>
</html>