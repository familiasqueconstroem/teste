<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tijol√¥metro ‚Äî Cada Tijolo Conta</title>
<style>
:root{
  /* Cores base */
  --bg:#FFFAF5; --grout:#E5DBD1; --grid:#CDBFB3; --brick-bg:#a35a41; --joint:0.8px;
  /* Layout */
  --pad:0px; --panel-max:1600px;
  /* Mascote */
  --mascot-size: clamp(120px, 24vmin, 280px);
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
  background:var(--bg); color:#111; display:flex; align-items:center; justify-content:center; padding:12px;
}
@keyframes fadeIn{from{opacity:0;transform:scale(.985)} to{opacity:1;transform:scale(1)}}
.panel{
  width:min(var(--panel-max),98vw);
  background:#fff; border-radius:20px; box-shadow:0 8px 30px rgba(0,0,0,.08);
  padding:16px; display:flex; flex-direction:column; gap:16px; animation:fadeIn .45s ease-out both;
}

/* ----- √Årea principal ----- */
.gauge{
  position:relative; width:100%; min-height:300px;
  border-radius:14px; overflow:hidden; background:#F7EFE7;
}
.ghost-logo{
  position:absolute; inset:var(--pad);
  width:calc(100% - (var(--pad) * 2)); height:calc(100% - (var(--pad) * 2));
  margin:auto; object-fit:contain; opacity:0; /* s√≥ para aspect-ratio */
}
.bricks{ position:relative; width:100%; height:100% }
.brick{
  position:absolute; background:var(--grout); border-radius:2px; overflow:hidden;
  box-shadow: inset 0 0 0 var(--joint) var(--grid);
}
.brick .fill{ position:absolute; inset:0; width:0%; height:100%; transition:width .35s ease; background:var(--brick-bg) }
.brick.filled .fill{ width:100% }
.bricks-bg{ position:absolute; inset:0 }
.mask-layer{
  position:absolute; inset:0; background:transparent; --mask:url('logo.png');
  -webkit-mask-image:var(--mask); mask-image:var(--mask);
  -webkit-mask-repeat:no-repeat; mask-repeat:no-repeat;
  -webkit-mask-position:center; mask-position:center;
  -webkit-mask-size:contain; mask-size:contain;
}

/* ----- HUD ----- */
.hud{
  display:grid; grid-template-columns: repeat(4, minmax(0,1fr));
  gap:10px; padding:10px; border:1px solid #eee; border-radius:12px; background:#fdfdfd;
  font-variant-numeric: tabular-nums;
}
.hud .k label{ display:block; font-size:12px; color:#666; margin-bottom:4px }
.hud .k b{ font-size:20px }
.hud .updated{ font-size:11px; color:#777; align-self:end; text-align:right }

/* ----- Alert ----- */
.alert{
  position:absolute; left:14px; top:14px; background:#fff3cd; border:1px solid #ffe69c; color:#664d03;
  padding:8px 10px; border-radius:10px; font-size:12px; display:none; z-index:9;
}
.alert b{ display:block; margin-bottom:4px }

/* ----- Mascote ----- */
.mascot{
  position:absolute; right:12px; bottom:10px; z-index:6;
  width:var(--mascot-size); height:auto; display:none; transform-origin:50% 100%;
  filter: drop-shadow(0 12px 24px rgba(0,0,0,.25));
}
.mascot.bob{ animation:mascotBob 3s ease-in-out infinite }
@keyframes mascotBob{0%,100%{transform:translateY(0)} 50%{transform:translateY(-3px)}}
.mascot.wave{ animation:mascotWave .9s ease 1 }
@keyframes mascotWave{
  0%{transform:translateY(0) rotate(0)} 25%{transform:translateY(-2deg) rotate(-3deg)}
  50%{transform:translateY(0) rotate(2deg)} 75%{transform:translateY(-1deg) rotate(-2deg)}
  100%{transform:translateY(0) rotate(0)}
}
.mascot-bubble{
  position:absolute; right:calc(var(--mascot-size) - 10px); bottom:calc(100% - 8px);
  background:#fff; color:#222; border-radius:12px; padding:8px 10px; max-width:52ch;
  box-shadow:0 8px 24px rgba(0,0,0,.18); font-size:14px; line-height:1.3; display:none; z-index:7;
}
.mascot-bubble.show{ display:block; animation:fadeUp .22s ease }
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)}}
.throw-brick{ position:fixed; z-index:5; border-radius:2px; background:var(--brick-bg); box-shadow: inset 0 0 0 var(--joint) var(--grid); }
@media (max-width:640px){ .mascot{ right:8px; bottom:8px } .mascot-bubble{ right:calc(var(--mascot-size) - 16px) } }
@media (prefers-reduced-motion: reduce){ .mascot.bob, .mascot.wave{ animation:none !important } }

/* ----- FABs + Painel (simples) ----- */
.fab{position:fixed;right:18px;z-index:9998;width:54px;height:54px;border-radius:50%;
  color:#fff;display:flex;align-items:center;justify-content:center;
  box-shadow:0 12px 28px rgba(0,0,0,.18);cursor:pointer;font-size:22px;border:0}
.fab:active{transform:scale(.98)}
#fab{bottom:18px;background:#0A4AA6}
#shareFab{bottom:86px;background:#25D366}
.drawer{position:fixed;inset:0 0 0 auto;width:340px;max-width:92vw;background:#fff;border-left:1px solid #eee;
  box-shadow:-16px 0 40px rgba(0,0,0,.18);transform:translateX(105%);transition:transform .28s ease;z-index:9999;
  display:flex;flex-direction:column}
.drawer.open{transform:none}
.drawer .head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eee}
.drawer .body{padding:12px 16px 18px;overflow:auto}
.drawer .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
.drawer select,.drawer input[type="range"]{width:100%;font:inherit;padding:6px 8px;border:1px solid #ddd;border-radius:8px;background:#fff}
.drawer .btn{padding:8px 12px;border-radius:10px;border:1px solid #ddd;background:#fafafa;cursor:pointer}
.drawer .btn.primary{background:#0A4AA6;color:#fff;border-color:#0A4AA6}
.drawer h4{margin:14px 0 6px 0}
.drawer .small{font-size:12px;color:#666}

/* ----- Share Sheet (sele√ß√£o de mensagem) ----- */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:flex-end;justify-content:center;z-index:10000}
.modal.show{display:flex}
.sheet{background:#fff; width:min(640px, 96vw); border-radius:16px 16px 0 0; box-shadow:0 -12px 36px rgba(0,0,0,.3); padding:14px 14px 16px}
.sheet .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.sheet .opt{display:flex; gap:8px; align-items:flex-start; padding:10px; border:1px solid #eee; border-radius:12px; margin:8px 0}
.sheet .opt input{margin-top:2px}
.sheet .preview{font-size:14px; background:#fafafa; border:1px dashed #ddd; border-radius:10px; padding:10px; margin-top:8px; white-space:pre-wrap}
.sheet .row{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
.sheet .btn{padding:8px 12px;border-radius:10px;border:1px solid #ddd;background:#fafafa;cursor:pointer}
.sheet .btn.primary{background:#25D366;color:#fff;border-color:#25D366}
</style>
</head>
<body>
  <div class="panel">
    <div class="gauge" id="gauge">
      <div class="alert" id="logoAlert"><b>Logo n√£o carregou</b> ‚Äî verifique <code>logo.png</code>.</div>

      <!-- ‚Äúfantasma‚Äù s√≥ para aspect-ratio -->
      <img id="ghostLogo" class="ghost-logo" alt="logo" />

      <!-- fundo (vazios) -->
      <div class="bricks-bg"><div class="bricks" id="bricksBg"></div></div>

      <!-- frente (recortada no logo) -->
      <div class="mask-layer" id="mask"><div class="bricks" id="bricksFg"></div></div>

      <!-- mascote -->
      <img id="mascotImg" class="mascot" alt="Mascote" />
      <div id="mascotBubble" class="mascot-bubble"></div>
    </div>

    <div class="hud">
      <div class="k"><label>Arrecadado</label><b id="hudRaised">R$ 0,00</b></div>
      <div class="k"><label id="hudGoalLabel">Meta</label><b id="hudGoal">R$ 0,00</b></div>
      <div class="k"><label>Progresso</label><b id="hudPct">0%</b></div>
      <div class="updated" id="hudUpdated">‚Äî</div>
    </div>
  </div>

  <!-- Tooltip gen√©rico -->
  <div id="tip" style="position:fixed;display:none;min-width:140px;max-width:60ch;background:#fff;border:1px solid #eee;border-radius:10px;padding:8px 10px;box-shadow:0 8px 24px rgba(0,0,0,.15);z-index:9990;font-size:13px;line-height:1.25"></div>

  <!-- FABs -->
  <button class="fab" id="shareFab" title="Compartilhar">üì£</button>
  <button class="fab" id="fab" title="Op√ß√µes">‚öôÔ∏è</button>

  <!-- Painel (simplificado) -->
  <aside class="drawer" id="drawer" aria-label="Op√ß√µes do Tijol√¥metro">
    <div class="head">
      <strong>Op√ß√µes</strong>
      <button class="btn" id="closeDrawer">Fechar</button>
    </div>
    <div class="body">
      <h4>Visual</h4>
      <div class="row">
        <label>Paleta</label>
        <select id="optPalette">
          <option value="brand5">Brand 5 (logo 5 cores)</option>
          <option value="brand3">Brand 3 (azul/amarelo/vinho)</option>
          <option value="brand2">Brand 2 (azul/amarelo)</option>
        </select>
      </div>
      <div class="row">
        <label><input type="checkbox" id="optAutoDensity" checked> Densidade autom√°tica</label>
      </div>
      <div class="row">
        <label>Tamanho do tijolo</label>
        <input type="range" id="optBrickPx" min="8" max="22" step="1" disabled>
      </div>

      <h4>Mascote</h4>
      <div class="row"><label><input type="checkbox" id="optMascotOn" checked> Mostrar mascote</label></div>

      <h4>Doadores</h4>
      <div class="row"><label><input type="checkbox" id="optDonorsOn"> Tooltips de doadores</label></div>
      <div class="small">L√™ automaticamente da aba <b>TIJOLO_Respostas</b> (Forms):<br>‚Ä¢ Mensagem: cabe√ßalho <b>‚ÄúTexto do tijolo 1 (m√°x. 40)‚Äù</b><br>‚Ä¢ Nome: 1¬™ coluna cujo cabe√ßalho cont√©m ‚Äúnome‚Äù</div>

      <h4>Som</h4>
      <div class="row"><label><input type="checkbox" id="optSoundOn"> Som ligado</label></div>
      <div class="row">
        <label>Trilha</label>
        <select id="optTrack"></select>
      </div>

      <h4>A√ß√µes</h4>
      <div class="row" style="justify-content:space-between">
        <button class="btn" id="btnApply">Salvar & aplicar</button>
        <button class="btn primary" id="btnRefresh">Atualizar agora</button>
      </div>
      <div class="row"><button class="btn" id="btnReset">Restaurar padr√£o</button></div>
    </div>
  </aside>

  <!-- Share Sheet (sele√ß√£o de mensagem) -->
  <div class="modal" id="shareModal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-label="Compartilhar Tijol√¥metro">
      <div class="head">
        <strong>Compartilhar</strong>
        <button class="btn" id="shareClose">Fechar</button>
      </div>
      <div class="opt"><input type="radio" name="tpl" id="tpl1" value="1">
        <label for="tpl1"><b>#1</b> ‚Äî Direto e caloroso<br>
          <small>üß± Fam√≠lias que Constroem ‚Äì Associa√ß√£o de Pais do Col√©gio Luzeiros. J√° chegamos a {PCT} da meta de {META}. Veja o Tijol√¥metro e participe: {LINK} üíõ</small>
        </label>
      </div>
      <div class="opt"><input type="radio" name="tpl" id="tpl2" value="2">
        <label for="tpl2"><b>#2</b> ‚Äî Convite<br>
          <small>üíõ Cada Tijolo Conta! A Associa√ß√£o de Pais do Col√©gio Luzeiros convida voc√™ a somar na campanha Fam√≠lias que Constroem. Estamos em {PCT} da meta ({META}). Participe: {LINK}</small>
        </label>
      </div>
      <div class="opt"><input type="radio" name="tpl" id="tpl3" value="3">
        <label for="tpl3"><b>#3</b> ‚Äî Bem curto (WhatsApp)<br>
          <small>üöß Fam√≠lias que Constroem ‚Äî Associa√ß√£o de Pais do Col√©gio Luzeiros. {PCT} da meta ({META}). Junte-se: {LINK} üß±</small>
        </label>
      </div>
      <div class="preview" id="sharePreview">Pr√©via‚Ä¶</div>
      <div class="row">
        <button class="btn" id="shareSetDefault">Usar como padr√£o</button>
        <button class="btn primary" id="shareGo">Compartilhar</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // -------------------- IDs das planilhas --------------------
  const FORMS_SHEET_ID = '1CbyqJL0lpYAzxBXRw9dvUh5DHh50imJOw5AUjVALy8I'; // <- DOADORES (Forms)
  const PANEL_SHEET_ID = '1ZL3CcoMDVdQE8ooRX9L5QFqX1Rc70L9uguDxcmTJqGY'; // <- Tijol√¥metro (arrecadado/meta)

  // -------------------- CONFIG + prefer√™ncias --------------------
  const qs = new URLSearchParams(location.search);
  const DEFAULTS = {
    sheetId: qs.get('sheet_id') || PANEL_SHEET_ID, // painel
    sheetName: qs.get('sheet')  || 'Tijolometro',
    range: qs.get('range')      || 'A1:D10',  // R√≥tulo / Valor / In√≠cio / Fim
    logo:  qs.get('logo')       || 'logo.png',
    palette: qs.get('palette')  || 'brand5',
    cols: 120, rows: 72, brickPx: 0, gap: 1, pollMs: 30000,
    mascotOn:true,

    donorsOn:false,
    donorsSheetId: FORMS_SHEET_ID,     // <- lido do Forms
    donorsSheet: 'TIJOLO_Respostas',   // <- nome da aba
    donorsRange: 'A1:Z1000',           // <- inclui cabe√ßalho na linha 1
    formsMsgHeader: 'Texto do tijolo 1 (m√°x. 40)',

    soundOn:false,
    trackSrc:'', // ser√° detectado
  };
  const PREFKEY='tj:settings';
  function loadPrefs(){ try{return JSON.parse(localStorage.getItem(PREFKEY)||'{}')}catch{return{}} }
  function savePrefs(p){ localStorage.setItem(PREFKEY, JSON.stringify(p)); }
  const PREFS={...DEFAULTS, ...loadPrefs()};

  // -------------------- elementos base --------------------
  const gauge = document.getElementById('gauge');
  const maskEl = document.getElementById('mask');
  const ghostEl = document.getElementById('ghostLogo');
  const bricksFgEl = document.getElementById('bricksFg');
  const bricksBgEl = document.getElementById('bricksBg');
  const alertBox = document.getElementById('logoAlert');
  const hud = {
    raised: document.getElementById('hudRaised'),
    goal: document.getElementById('hudGoal'),
    pct: document.getElementById('hudPct'),
    updated: document.getElementById('hudUpdated'),
    goalLabel: document.getElementById('hudGoalLabel')
  };
  const tip = document.getElementById('tip');

  // estado para compartilhamento
  const shareState = { raised:0, goal:0, pctText:'0%' };
  const SHARE_PREF_KEY='tj:shareTpl';
  const shareModal = document.getElementById('shareModal');
  const shareClose = document.getElementById('shareClose');
  const sharePreview = document.getElementById('sharePreview');
  const shareGo = document.getElementById('shareGo');
  const shareSetDefault = document.getElementById('shareSetDefault');

  // -------------------- utils --------------------
  function setMaskImage(url){ maskEl.style.setProperty('--mask', `url('${url}')`); }
  function formatBRL(n){ try{ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(n);}catch{return 'R$ '+Number(n||0).toLocaleString('pt-BR');} }
  function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
  const paintCanvas = document.createElement('canvas');
  const pctx = paintCanvas.getContext('2d', { willReadFrequently:true });
  let logoImg=null, aspectSet=false, bricksFg=[], bricksBg=[], effCols, effRows, lastProgress=0;
  let _orderFg=[], _orderBg=[]; // <‚Äî √∫nico lugar onde declaramos a ordem

  // -------------------- paleta de mapeamento --------------------
  const PALETTES = {
    brand2:['#0A4AA6','#F2C035'],
    brand3:['#0A4AA6','#F2C035','#8B1E1E'],
    brand5:['#0A4AA6','#F2C035','#8B1E1E','#A35A41','#2D2A2A']
  };
  const hex2rgb = h => { const n=parseInt(h.replace('#',''),16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; };
  const dist2 = (a,b)=>{const dr=a.r-b.r,dg=a.g-b.g,db=a.b-b.b;return dr*dr+dg*dg+db*db};
  function mapToPalette(r,g,b,name){
    const p=PALETTES[name]; if(!p) return `rgb(${r},${g},${b})`;
    let best=p[0], dBest=Infinity, c={r,g,b};
    for(const h of p){ const d=dist2(c,hex2rgb(h)); if(d<dBest){dBest=d;best=h} }
    return best;
  }
  const makeSampler = (data,W,H)=>(x,y)=>{const xi=Math.max(0,Math.min(W-1,Math.round(x))); const yi=Math.max(0,Math.min(H-1,Math.round(y))); const i=(yi*W+xi)*4; return [data[i],data[i+1],data[i+2],data[i+3]];};
  const median = a => {const b=a.slice().sort((m,n)=>m-n); return b[Math.floor(b.length/2)]};

  // -------------------- logo -> cores de tijolos --------------------
  function loadLogo(src){
    return new Promise((resolve)=>{
      const im = new Image();
      im.onload = ()=>{ logoImg=im; ghostEl.src=im.src; setMaskImage(im.src); alertBox.style.display='none'; resolve(true); };
      im.onerror = ()=>{ alertBox.style.display='block'; resolve(false); };
      im.src = src + (src.includes('?') ? '&' : '?') + 't=' + Date.now();
    });
  }
  function ensureAspectFromLogo(){
    if(aspectSet || !logoImg) return;
    const ar = logoImg.naturalWidth / logoImg.naturalHeight;
    if(ar>0) gauge.style.aspectRatio = `${ar} / 1`;
    aspectSet = true;
  }
  function colorizeBricks(){
    if(!logoImg) return;
    const W=bricksFgEl.clientWidth, H=bricksFgEl.clientHeight; if(!W||!H) return;
    paintCanvas.width=W; paintCanvas.height=H; pctx.clearRect(0,0,W,H);
    // desenha logo centralizado
    const ar=logoImg.naturalWidth/logoImg.naturalHeight; let dw=W, dh=W/ar; if(dh>H){dh=H; dw=H*ar}
    const dx=(W-dw)/2, dy=(H-dh)/2; pctx.drawImage(logoImg,dx,dy,dw,dh);
    const buf=pctx.getImageData(0,0,W,H).data; const samp=makeSampler(buf,W,H);
    for(let i=0;i<bricksFg.length;i++){
      const f=bricksFg[i], b=bricksBg[i], x=f._x, y=f._y, w=f._w, h=f._h;
      const pts=[[x+w/2,y+h/2],[x+1,y+1],[x+w-2,y+1],[x+1,y+h-2],[x+w-2,y+h-2],[x+w/2,y+1],[x+w/2,y+h-2],[x+1,y+h/2],[x+w-2,y+h/2]];
      const rs=[],gs=[],bs=[],as=[]; for(const [px,py] of pts){ const d=samp(px,py); rs.push(d[0]); gs.push(d[1]); bs.push(d[2]); as.push(d[3]); }
      const A=median(as), ff=f.querySelector('.fill'), bf=b.querySelector('.fill');
      if (A<100){ ff.style.background='transparent'; bf.style.opacity='1'; }
      else{ const r=median(rs), g=median(gs), bb=median(bs); ff.style.background=mapToPalette(r,g,bb, PREFS.palette); bf.style.opacity='0'; }
    }
  }

  // -------------------- layout da grade --------------------
  function buildOrder(rows,cols){ const of=[],ob=[]; for(let r=rows-1;r>=0;r--){ for(let c=0;c<cols;c++){ const i=r*cols+c; of.push(bricksFg[i]); ob.push(bricksBg[i]); } } return [of,ob]; }
  function layoutBricks(){
    ensureAspectFromLogo(); const W=bricksFgEl.clientWidth, H=bricksFgEl.clientHeight; if(!W||!H) return;
    if (PREFS.brickPx>0){ const bw=PREFS.brickPx,bh=Math.round(bw*0.6); effCols=Math.max(20,Math.floor((W-PREFS.gap)/(bw+PREFS.gap))); effRows=Math.max(12,Math.floor((H-PREFS.gap)/(bh+PREFS.gap))); }
    const cols=(typeof effCols==='number'&&effCols>0)? effCols : PREFS.cols;
    const rows=(typeof effRows==='number'&&effRows>0)? effRows : PREFS.rows;
    const gap=PREFS.gap;
    let brickW=Math.floor((W-(cols+1)*gap)/cols); if(brickW<2) brickW=2;
    let offset=Math.floor(brickW/2), gridWEven=cols*brickW+(cols+1)*gap, gridWOdd=gridWEven+offset;
    if(gridWOdd>W){ const extra=gridWOdd-W, reduce=Math.ceil(extra/cols); brickW=Math.max(2,brickW-reduce); offset=Math.floor(brickW/2); gridWEven=cols*brickW+(cols+1)*gap; gridWOdd=gridWEven+offset; }
    const brickH=Math.max(2,Math.floor((H-(rows+1)*gap)/rows)); const gridWMax=Math.max(gridWEven,gridWOdd); const startXBase=Math.max(gap,Math.floor((W-gridWMax)/2)+gap);
    const total=rows*cols;
    if(bricksFg.length!==total){
      bricksFgEl.innerHTML=''; bricksBgEl.innerHTML=''; bricksFg=[]; bricksBg=[];
      const ff=document.createDocumentFragment(), bb=document.createDocumentFragment();
      for(let i=0;i<total;i++){
        const f=document.createElement('div'); f.className='brick'; f.appendChild(document.createElement('div')).className='fill'; ff.appendChild(f); bricksFg.push(f);
        const b=document.createElement('div'); b.className='brick'; b.appendChild(document.createElement('div')).className='fill'; bb.appendChild(b); bricksBg.push(b);
      }
      bricksFgEl.appendChild(ff); bricksBgEl.appendChild(bb);
    }
    let idx=0; for(let r=0;r<rows;r++){ const startX=startXBase+(r%2?offset:0);
      for(let c=0;c<cols;c++){ const x=startX+c*(brickW+gap), y=gap+r*(brickH+gap);
        const f=bricksFg[idx], b=bricksBg[idx];
        f.style.cssText=`left:${x}px;top:${y}px;width:${brickW}px;height:${brickH}px;`; f._x=x; f._y=y; f._w=brickW; f._h=brickH;
        b.style.cssText=`left:${x}px;top:${y}px;width:${brickW}px;height:${brickH}px;`; idx++; } }
    colorizeBricks(); applyProgress(lastProgress);
  }

  // -------------------- progresso (preenchimento) --------------------
  function applyProgress(p){
    p=Math.max(0,Math.min(1,p||0)); lastProgress=p;
    const cols=(typeof effCols==='number'&&effCols>0)? effCols : PREFS.cols;
    const rows=(typeof effRows==='number'&&effRows>0)? effRows : PREFS.rows;
    [_orderFg, _orderBg] = buildOrder(rows,cols);
    const total=_orderFg.length; if(!total) return;
    const filled=Math.floor(p*total), frac=(p*total)-filled;
    for(let i=0;i<total;i++){
      const fF=_orderFg[i].querySelector('.fill'), fB=_orderBg[i].querySelector('.fill');
      _orderFg[i].classList.remove('filled','partial'); fF.style.width='0%'; _orderBg[i].classList.remove('filled','partial'); fB.style.width='0%';
      if(i<filled){ _orderFg[i].classList.add('filled'); fF.style.width='100%'; _orderBg[i].classList.add('filled'); fB.style.width='100%'; }
    }
    if(filled<total){
      const fF=_orderFg[filled].querySelector('.fill'), fB=_orderBg[filled].querySelector('.fill'); const percent=Math.round(frac*100)+'%';
      _orderFg[filled].classList.add('partial'); fF.style.width=percent; _orderBg[filled].classList.add('partial'); fB.style.width=percent;
    }
    if (window._hookAfterApplyProgress) window._hookAfterApplyProgress({filled,total});
  }

  // -------------------- Google Sheets (painel) --------------------
  async function fetchProgress(){
    const base=`https://docs.google.com/spreadsheets/d/${PREFS.sheetId}/gviz/tq`;
    const params=new URLSearchParams({ tqx:'out:json', sheet:PREFS.sheetName, range:PREFS.range, t:Date.now()+'' });
    try{
      const res=await fetch(`${base}?${params}`,{ cache:'no-store' }); const txt=await res.text();
      const m=txt.match(/google\.visualization\.Query\.setResponse\((.*)\);/s); const data=JSON.parse(m[1]); const rows=data.table.rows||[];

      const raisedRow = rows.find(r => r.c?.[0]?.v?.toString().trim().toLowerCase() === 'arrecadado');
      const raised = raisedRow ? Number(raisedRow.c?.[1]?.v || 0) : 0;

      const today = new Date(); today.setHours(0,0,0,0);
      let activeGoal=0, activeLabel='Meta';
      for (const r of rows){
        const label=r.c?.[0]?.v?.toString().trim();
        if(!label || label.toLowerCase()==='arrecadado') continue;
        const goal=Number(r.c?.[1]?.v || 0);
        const s=r.c?.[2]?.v, e=r.c?.[3]?.v;
        if(s && e){
          const S=new Date(...s.match(/\d+/g).map(Number));
          const E=new Date(...e.match(/\d+/g).map(Number));
          if(today>=S && today<=E){ activeGoal=goal; activeLabel=label; break; }
        }
      }
      if(!activeGoal && rows.length>1){ const r=rows[1]; activeLabel=r.c?.[0]?.v?.toString().trim()||'Meta'; activeGoal=Number(r.c?.[1]?.v||0); }

      const p=activeGoal>0 ? raised/activeGoal : 0;
      applyProgress(p);

      hud.raised.textContent = formatBRL(raised);
      hud.goal.textContent   = formatBRL(activeGoal);
      hud.goalLabel.textContent = activeLabel;
      hud.pct.textContent    = Math.max(0,Math.min(100,p*100)).toFixed(1).replace('.',',')+'%';
      hud.updated.textContent= new Date().toLocaleString('pt-BR',{dateStyle:'short',timeStyle:'short'});

      // share state
      shareState.raised = raised; shareState.goal = activeGoal; shareState.pctText = hud.pct.textContent;

    }catch(e){
      console.error('Planilha painel:', e);
      if(hud.updated.textContent==='‚Äî'){ hud.updated.textContent='(aguardando planilha)'; }
    }
  }

  // -------------------- Doadores (Forms auto) --------------------
  let donors=[];
  function firstName(n){ if(!n) return ''; const p=n.trim().split(/\s+/); return p[0]+(p[1]?' '+p[1][0]+'.':''); }
  function formatName(n){ return n? firstName(n) : 'Doa√ß√£o recebida'; }

  async function fetchGVizById(sheetId, sheet, range){
    const base=`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq`;
    const params=new URLSearchParams({tqx:'out:json',sheet,range,t:Date.now()+''});
    const res=await fetch(`${base}?${params}`,{cache:'no-store'}); const txt=await res.text();
    const m=txt.match(/google\.visualization\.Query\.setResponse\((.*)\);/s); return JSON.parse(m[1]).table;
  }

  async function fetchDonors(){
    donors=[];
    if(!PREFS.donorsOn) return;
    try{
      const table=await fetchGVizById(PREFS.donorsSheetId, PREFS.donorsSheet, PREFS.donorsRange);
      const rows=table.rows||[]; if(!rows.length) return;

      const headers=(rows[0].c||[]).map(c=>(c?.v||'').toString().trim());
      // indices
      const idxMsg  = headers.findIndex(h => h.trim().toLowerCase() === PREFS.formsMsgHeader.trim().toLowerCase());
      const idxName = headers.findIndex(h => /nome/i.test(h));
      const idxVal  = headers.findIndex(h => /valor|doa(√ß|c)ao|r\$/i.test(h));

      for(let i=1;i<rows.length;i++){
        const c=rows[i].c||[];
        const name = idxName>=0 ? (c[idxName]?.v||'').toString() : '';
        const msg  = idxMsg >=0 ? (c[idxMsg ]?.v||'').toString() : '';
        const val  = idxVal >=0 ? Number(c[idxVal]?.v||0) : 0;
        if(name || msg || val) donors.push({name,msg,value:val});
      }
    }catch(e){ console.warn('Doadores (Forms):', e); donors=[]; }
  }

  function assignDonorsToFilled(filled){
    if(!PREFS.donorsOn || donors.length===0) return;
    for(let i=0;i<_orderFg.length;i++){
      const brick=_orderFg[i];
      if(i<filled) brick._donor = donors[i % donors.length];
      else brick._donor = null;
    }
  }

  // Tooltip
  bricksFgEl.addEventListener('click', onBrickTap, {passive:true});
  bricksFgEl.addEventListener('touchstart', onBrickTap, {passive:true});
  function onBrickTap(e){
    const b=e.target.closest('.brick'); if(!b) return;
    const rect=b.getBoundingClientRect();
    const donor=b._donor;
    let html='';
    if(PREFS.donorsOn && donor){
      html = `<b>${formatName(donor.name)}</b>` + (donor.msg?`<div>${donor.msg}</div>`:'') + (donor.value?`<div class="mini">${formatBRL(donor.value)}</div>`:'');
    }else{
      html = `<b>Obrigado!</b><div class="mini">Cada tijolo conta üíõ</div>`;
    }
    tip.innerHTML=html; tip.style.display='block';
    const left=Math.min(Math.max(8,rect.left+rect.width/2), innerWidth-160), top=Math.max(8,rect.top-12);
    tip.style.left=left+'px'; tip.style.top=top+'px';
    clearTimeout(onBrickTap._t); onBrickTap._t=setTimeout(()=> tip.style.display='none', 2200);
  }

  // -------------------- Mascote --------------------
  const mascotImg = document.getElementById('mascotImg');
  const mascotBubble = document.getElementById('mascotBubble');
  const MASCOT_CANDIDATES = ['mascot.png','mascote.png','Tio_Jolinho_tijolo.png','Tio_Jolinho_carrinho.png','Tio_Jolinho_martelo.png','Sr._Construtino_colher.png','Lumininha_trena.png'];

  function pickFirstExisting(srcs){
    return new Promise(resolve=>{
      const next=()=>{
        const src=srcs.shift(); if(!src) return resolve(null);
        const im=new Image();
        im.onload = ()=>resolve(src);
        im.onerror= next;
        im.src = src + '?v=' + Date.now();
      }; next();
    });
  }
  async function bootMascote(){
    if(!PREFS.mascotOn){ mascotImg.style.display='none'; return; }
    const chosen=await pickFirstExisting(MASCOT_CANDIDATES.slice());
    if(!chosen){ mascotImg.style.display='none'; return; }
    mascotImg.src = chosen + '?v=' + Date.now();
    mascotImg.style.display='block';
    mascotImg.classList.add('bob');
  }
  function say(text,ms=1800){
    if(!mascotBubble) return; mascotBubble.textContent=text; mascotBubble.classList.add('show');
    clearTimeout(say._t); say._t=setTimeout(()=>mascotBubble.classList.remove('show'),ms);
  }
  // Clique no mascote: aceno + fala + arremesso curto
  mascotImg.addEventListener('click', ()=>{
    mascotImg.classList.remove('wave'); void mascotImg.offsetWidth; mascotImg.classList.add('wave');
    say('Cada Tijolo Conta!');
    throwCuteBrick();
    if (audioState.on) ensureAudioPlays(); // garante reprodu√ß√£o ap√≥s gesto
  });

  function throwCuteBrick(){
    try{
      const rm=mascotImg.getBoundingClientRect();
      const sx = rm.left + rm.width*0.20, sy = rm.top + rm.height*0.66;
      const ex = sx + 80, ey = sy - 120; // arco curto para cima/direita
      const flying=document.createElement('div');
      flying.className='throw-brick';
      flying.style.left=sx+'px'; flying.style.top=sy+'px';
      flying.style.width='22px'; flying.style.height='14px';
      document.body.appendChild(flying);
      flying.animate([
        { transform:'translate(0,0) scale(.9)', opacity:.95 },
        { transform:`translate(${ex-sx}px, ${ey-sy}px) scale(1)`, opacity:1 },
        { transform:`translate(${ex-sx+20}px, ${ey-sy+40}px) scale(.95)`, opacity:.0 }
      ],{ duration:750, easing:'ease-out' }).onfinish=()=>flying.remove();
    }catch{}
  }

  // anima√ß√£o somente quando AUMENTAR (n√£o anima no 1¬∫ carregamento)
  let _prevFilled=null,_ready=false;
  window._hookAfterApplyProgress = function({filled,total}){
    assignDonorsToFilled(filled);
    if(_prevFilled===null){ _prevFilled=filled; _ready=true; return; }
    if(!_ready){ _ready=true; _prevFilled=filled; return; }
    if(filled>_prevFilled){
      const count=Math.min(filled-_prevFilled, 3);
      for(let i=0;i<count;i++) throwCuteBrick();
      say('Chegou tijolo novo! üß±', 1600);
      if (audioState.on) ensureAudioPlays();
    }
    _prevFilled=filled;
  };

  // -------------------- Som (m4a preferido + mp3 fallback) --------------------
  const audioCandidates = [
    'trilha1.m4a','trilha1.mp3',
    'trilha2.m4a','trilha2.mp3',
    'Cada_Tijolo_Conta.m4a','Cada_Tijolo_Conta.mp3',
    'cada-tijolo-conta!_ext_completa.m4a','cada-tijolo-conta!_ext_completa.mp3',
    'cada-tijolo-conta!_6.m4a','cada-tijolo-conta!_6.mp3'
  ];
  const audioState = { on: !!PREFS.soundOn, track: PREFS.trackSrc || '', el: null, found: [] };

  async function detectTracks(){
    const test = (src)=> new Promise(res=>{
      const a=new Audio(); a.preload='metadata';
      a.oncanplaythrough=()=>res(src);
      a.onerror=()=>res(null);
      a.src=src+'?v='+Date.now();
    });
    const results = await Promise.all(audioCandidates.map(test));
    audioState.found = results.filter(Boolean);
    if(!audioState.track || !audioState.found.includes(audioState.track)) audioState.track = audioState.found[0]||'';
    buildTrackSelect();
    if(audioState.on && audioState.track) ensureAudioPlays();
  }

  function ensureAudioPlays(){
    try{
      if(!audioState.track){ stopAudio(); return; }
      if(!audioState.el){
        audioState.el = new Audio();
        audioState.el.loop=true;
        audioState.el.volume=0.35;
      }
      if(!audioState.el.src || audioState.el.src.indexOf(audioState.track)===-1){
        audioState.el.src = audioState.track+'?v='+Date.now();
      }
      audioState.el.play().catch(()=>{/* precisa de gesto do usu√°rio (clicar mascote ajuda) */});
    }catch{}
  }
  function stopAudio(){ try{ if(audioState.el){ audioState.el.pause(); } }catch{} }

  // -------------------- Painel (simplificado) --------------------
  const fab=document.getElementById('fab'), drawer=document.getElementById('drawer'), closeDrawer=document.getElementById('closeDrawer');
  const optPalette=document.getElementById('optPalette'), optAutoDensity=document.getElementById('optAutoDensity'), optBrickPx=document.getElementById('optBrickPx');
  const optMascotOn=document.getElementById('optMascotOn');
  const optDonorsOn=document.getElementById('optDonorsOn');
  const optSoundOn=document.getElementById('optSoundOn'), optTrack=document.getElementById('optTrack');
  const btnApply=document.getElementById('btnApply'), btnRefresh=document.getElementById('btnRefresh'), btnReset=document.getElementById('btnReset');

  function buildTrackSelect(){
    optTrack.innerHTML='';
    audioState.found.forEach(src=>{
      const o=document.createElement('option'); o.value=src; o.textContent=src; optTrack.appendChild(o);
    });
    if(audioState.track){ optTrack.value = audioState.track; }
  }

  function syncControls(){
    optPalette.value = PREFS.palette;
    optAutoDensity.checked = PREFS.brickPx===0; optBrickPx.disabled = optAutoDensity.checked;
    optBrickPx.value = PREFS.brickPx || 14;

    optMascotOn.checked = PREFS.mascotOn;
    optDonorsOn.checked = PREFS.donorsOn;

    optSoundOn.checked = PREFS.soundOn;
    buildTrackSelect();
  }

  fab.onclick = ()=> drawer.classList.add('open');
  closeDrawer.onclick = ()=> drawer.classList.remove('open');

  btnApply.onclick = async ()=>{
    PREFS.palette = optPalette.value;
    PREFS.brickPx = optAutoDensity.checked ? 0 : Number(optBrickPx.value);
    PREFS.mascotOn = !!optMascotOn.checked;
    PREFS.donorsOn = !!optDonorsOn.checked;
    PREFS.soundOn = !!optSoundOn.checked;
    PREFS.trackSrc = optTrack.value || '';

    savePrefs(PREFS);

    // aplica
    colorizeBricks(); layoutBricks(); await fetchDonors(); await fetchProgress(); await bootMascote();
    if(PREFS.soundOn){ audioState.on=true; audioState.track=PREFS.trackSrc; ensureAudioPlays(); }
    else { audioState.on=false; stopAudio(); }
    drawer.classList.remove('open');
  };
  btnRefresh.onclick = ()=>{ fetchProgress(); fetchDonors(); };
  btnReset.onclick = ()=>{
    Object.keys(PREFS).forEach(k=>delete PREFS[k]); Object.assign(PREFS, DEFAULTS);
    savePrefs(PREFS); syncControls(); colorizeBricks(); layoutBricks(); fetchDonors(); fetchProgress(); bootMascote();
    if(PREFS.soundOn){ audioState.on=true; audioState.track=PREFS.trackSrc; ensureAudioPlays(); } else { audioState.on=false; stopAudio(); }
  };

  optAutoDensity.addEventListener('change',()=>{ optBrickPx.disabled=optAutoDensity.checked; });

  // -------------------- Compartilhar (com sele√ß√£o de template) --------------------
  const shareFab = document.getElementById('shareFab');
  function buildShareText(tplId){
    const LINK = location.href;
    const META = formatBRL(shareState.goal);
    const PCT  = shareState.pctText;
    if(tplId==='2'){
      return `üíõ Cada Tijolo Conta! A Associa√ß√£o de Pais do Col√©gio Luzeiros convida voc√™ a somar na campanha Fam√≠lias que Constroem.
Estamos em ${PCT} da meta (${META}). Participe: ${LINK}`;
    }else if(tplId==='3'){
      return `üöß Fam√≠lias que Constroem ‚Äî Associa√ß√£o de Pais do Col√©gio Luzeiros.
${PCT} da meta (${META}). Junte-se: ${LINK} üß±`;
    }
    // default #1
    return `üß± Fam√≠lias que Constroem ‚Äì Associa√ß√£o de Pais do Col√©gio Luzeiros.
J√° chegamos a ${PCT} da meta de ${META}.
Veja o Tijol√¥metro e participe: ${LINK} üíõ`;
  }
  function openShareSheet(){
    // marcar √∫ltimo template selecionado
    const last = localStorage.getItem(SHARE_PREF_KEY) || '1';
    (document.getElementById('tpl'+last) || document.getElementById('tpl1')).checked = true;
    // atualizar pr√©via
    updateSharePreview();
    shareModal.classList.add('show');
    shareModal.setAttribute('aria-hidden','false');
  }
  function closeShareSheet(){
    shareModal.classList.remove('show');
    shareModal.setAttribute('aria-hidden','true');
  }
  function updateSharePreview(){
    const sel = (document.querySelector('input[name="tpl"]:checked')||{}).value || '1';
    sharePreview.textContent = buildShareText(sel);
  }

  shareFab.addEventListener('click', openShareSheet);
  shareClose.addEventListener('click', closeShareSheet);
  document.getElementById('tpl1').addEventListener('change', updateSharePreview);
  document.getElementById('tpl2').addEventListener('change', updateSharePreview);
  document.getElementById('tpl3').addEventListener('change', updateSharePreview);

  shareSetDefault.addEventListener('click', ()=>{
    const sel = (document.querySelector('input[name="tpl"]:checked')||{}).value || '1';
    localStorage.setItem(SHARE_PREF_KEY, sel);
    shareSetDefault.textContent = 'Padr√£o salvo ‚úì';
    setTimeout(()=> shareSetDefault.textContent='Usar como padr√£o', 1400);
  });

  shareGo.addEventListener('click', async ()=>{
    const sel = (document.querySelector('input[name="tpl"]:checked')||{}).value || '1';
    const text = buildShareText(sel);
    try{
      if(navigator.share){
        await navigator.share({title:'Cada Tijolo Conta', text, url: location.href});
      }else{
        const wa = `https://wa.me/?text=${encodeURIComponent(text)}`;
        window.open(wa, '_blank');
      }
    }catch{} finally{
      closeShareSheet();
    }
  });

  // -------------------- Boot --------------------
  function syncControls(){ /* j√° definida acima */ }
  syncControls();
  window.addEventListener('resize', debounce(layoutBricks, 120));
  window.addEventListener('orientationchange', ()=> setTimeout(layoutBricks,150));

  loadLogo(DEFAULTS.logo).then(ok=>{ if(ok){ ensureAspectFromLogo(); layoutBricks(); } });
  fetchDonors();
  fetchProgress();
  bootMascote();
  detectTracks();

  setInterval(fetchProgress, DEFAULTS.pollMs);
})();
</script>
</body>
</html>
