<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tijolômetro — Cada Tijolo Conta</title>
<style>
:root{
  --bg:#FFFAF5; --grout:#E5DBD1; --grid:#CDBFB3; --brick-bg:#a35a41; --joint:0.8px;
  --panel-max:1600px; --pad:0px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
  background:var(--bg); color:#111; display:flex; align-items:center; justify-content:center; padding:12px;
}
.panel{
  width:min(var(--panel-max),98vw);
  background:#fff; border-radius:20px; box-shadow:0 8px 30px rgba(0,0,0,.08);
  padding:16px; display:flex; flex-direction:column; gap:16px;
}
.gauge{
  position:relative; width:100%; min-height:300px;
  border-radius:14px; overflow:hidden; background:#F7EFE7;
}
.ghost-logo{
  position:absolute; inset:var(--pad);
  width:calc(100% - (var(--pad)*2)); height:calc(100% - (var(--pad)*2));
  object-fit:contain; opacity:0; /* só para manter aspect-ratio do logo */
}
.bricks{ position:relative; width:100%; height:100% }
.brick{
  position:absolute; background:var(--grout); border-radius:2px; overflow:hidden;
  box-shadow: inset 0 0 0 var(--joint) var(--grid);
}
.brick .fill{ position:absolute; inset:0; width:0%; height:100%; transition:width .35s ease; background:var(--brick-bg) }
.brick.filled .fill{ width:100% }
.bricks-bg{ position:absolute; inset:0 }
.mask-layer{
  position:absolute; inset:0; background:transparent; --mask:url('logo.png');
  -webkit-mask-image:var(--mask); mask-image:var(--mask);
  -webkit-mask-repeat:no-repeat; mask-repeat:no-repeat;
  -webkit-mask-position:center; mask-position:center;
  -webkit-mask-size:contain; mask-size:contain;
}

/* HUD: rótulo em cima */
.hud{
  display:grid; grid-template-columns: repeat(4, minmax(0,1fr));
  gap:10px; padding:10px; border:1px solid #eee; border-radius:12px; background:#fdfdfd;
  font-variant-numeric: tabular-nums;
}
.hud .k label{ display:block; font-size:12px; color:#666; margin-bottom:4px }
.hud .k b{ font-size:20px }
.hud .updated{ font-size:11px; color:#777; align-self:end; text-align:right }

.alert{
  position:absolute; left:14px; top:14px; background:#fff3cd; border:1px solid #ffe69c; color:#664d03;
  padding:8px 10px; border-radius:10px; font-size:12px; display:none; z-index:9;
}
.alert b{ display:block; margin-bottom:4px }

/* Mascote (opcional) */
.mascot{
  position:absolute; right:12px; bottom:10px; z-index:6;
  width:clamp(120px, 24vmin, 280px); height:auto; display:none;
  filter: drop-shadow(0 12px 24px rgba(0,0,0,.25));
}
.mascot.wave{ animation:wave .8s ease 1 }
@keyframes wave{0%{transform:rotate(0)}25%{transform:rotate(-3deg)}50%{transform:rotate(2deg)}75%{transform:rotate(-2deg)}100%{transform:rotate(0)}}
.mascot-bubble{
  position:absolute; right:180px; bottom:140px; background:#fff; color:#222;
  border-radius:12px; padding:8px 10px; max-width:48ch; box-shadow:0 8px 24px rgba(0,0,0,.18);
  font-size:14px; line-height:1.3; display:none; z-index:7;
}
.mascot-bubble.show{ display:block }

/* Dev status (mostra erro JS) */
#devStatus{
  position:fixed; left:10px; bottom:10px; z-index:9999; font:12px/1.2 system-ui;
  background:#e6ffed; color:#036703; border:1px solid #b7efc0; padding:6px 8px; border-radius:8px;
}
#devStatus.err{ background:#ffe6e6; color:#8a0000; border-color:#ffb3b3 }
</style>
</head>
<body>
  <div class="panel">
    <div class="gauge" id="gauge">
      <div class="alert" id="logoAlert"><b>Logo não carregou</b> — verifique <code>logo.png</code>.</div>

      <img id="ghostLogo" class="ghost-logo" alt="logo" />
      <div class="bricks-bg"><div class="bricks" id="bricksBg"></div></div>
      <div class="mask-layer" id="mask"><div class="bricks" id="bricksFg"></div></div>

      <img id="mascot" class="mascot" alt="Mascote" />
      <div id="bubble" class="mascot-bubble">Cada Tijolo Conta!</div>
    </div>

    <div class="hud">
      <div class="k"><label>Arrecadado</label><b id="hudRaised">R$ 0,00</b></div>
      <div class="k"><label id="hudGoalLabel">Meta</label><b id="hudGoal">R$ 0,00</b></div>
      <div class="k"><label>Progresso</label><b id="hudPct">0%</b></div>
      <div class="updated" id="hudUpdated">—</div>
    </div>
  </div>

  <div id="devStatus" style="display:none"></div>

<script>
(function(){
  // IDs das planilhas (as que já vinham funcionando)
  const PANEL_SHEET_ID = '1ZL3CcoMDVdQE8ooRX9L5QFqX1Rc70L9uguDxcmTJqGY'; // Arrecadado/Meta (A1:D10)
  const CONFIG = {
    sheetId: PANEL_SHEET_ID,
    sheetName: 'Tijolometro',
    range: 'A1:D10',
    logo: 'logo.png',
    palette: 'brand5',
    cols: 120, rows: 72, gap: 1
  };

  // Estado / elementos
  const gauge = document.getElementById('gauge');
  const maskEl = document.getElementById('mask');
  const ghostEl = document.getElementById('ghostLogo');
  const bricksFgEl = document.getElementById('bricksFg');
  const bricksBgEl = document.getElementById('bricksBg');
  const alertBox = document.getElementById('logoAlert');
  const hud = {
    raised: document.getElementById('hudRaised'),
    goal: document.getElementById('hudGoal'),
    pct: document.getElementById('hudPct'),
    updated: document.getElementById('hudUpdated'),
    goalLabel: document.getElementById('hudGoalLabel')
  };
  const dev = document.getElementById('devStatus');

  let logoImg=null, aspectSet=false, bricksFg=[], bricksBg=[], effCols, effRows, lastProgress=0;
  let _orderFg=[], _orderBg=[];

  // Dev banner p/ erros
  function devInfo(msg, isErr=false){
    dev.textContent = msg;
    dev.className = isErr ? 'err' : '';
    dev.style.display = 'block';
  }
  window.onerror = function(msg, src, line, col, err){ devInfo('ERRO: '+msg, true); };

  // Utilitários
  function setMaskImage(url){ maskEl.style.setProperty('--mask', `url('${url}')`); }
  function formatBRL(n){ try{ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(n);}catch{return 'R$ '+Number(n||0).toLocaleString('pt-BR');} }
  function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
  function parseGVizDate(v){
    if(!v) return null;
    if (typeof v === 'string'){
      // tenta padrão Date(YYYY,MM,DD)
      let m = v.match(/Date\((\d+),\s*(\d+),\s*(\d+)/);
      if(m) return new Date(Number(m[1]), Number(m[2]), Number(m[3])); // já é 0-based
      // tenta números soltos
      const p = v.match(/\d+/g);
      if(p && p.length>=3) return new Date(Number(p[0]), Number(p[1])-1, Number(p[2]));
    }
    return null;
  }

  // Paleta
  const PALETTES = {
    brand2:['#0A4AA6','#F2C035'],
    brand3:['#0A4AA6','#F2C035','#8B1E1E'],
    brand5:['#0A4AA6','#F2C035','#8B1E1E','#A35A41','#2D2A2A']
  };
  const hex2rgb = h => { const n=parseInt(h.replace('#',''),16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; };
  const dist2 = (a,b)=>{const dr=a.r-b.r,dg=a.g-b.g,db=a.b-b.b;return dr*dr+dg*dg+db*db};
  function mapToPalette(r,g,b,name){
    const p=PALETTES[name]; if(!p) return `rgb(${r},${g},${b})`;
    let best=p[0], dBest=Infinity, c={r,g,b};
    for(const h of p){ const d=dist2(c,hex2rgb(h)); if(d<dBest){dBest=d;best=h} }
    return best;
  }

  // Canvas p/ amostrar cores do logo
  const paintCanvas = document.createElement('canvas');
  const pctx = paintCanvas.getContext('2d', { willReadFrequently:true });
  const makeSampler = (data,W,H)=>(x,y)=>{
    const xi=Math.max(0,Math.min(W-1,Math.round(x)));
    const yi=Math.max(0,Math.min(H-1,Math.round(y)));
    const i=(yi*W+xi)*4; return [data[i],data[i+1],data[i+2],data[i+3]];
  };
  const median = a => {const b=a.slice().sort((m,n)=>m-n); return b[Math.floor(b.length/2)]};

  // Logo
  function loadLogo(src){
    return new Promise((resolve)=>{
      const im = new Image();
      im.onload = ()=>{ logoImg=im; ghostEl.src=im.src; setMaskImage(im.src); alertBox.style.display='none'; resolve(true); };
      im.onerror = ()=>{ alertBox.style.display='block'; resolve(false); };
      im.src = src + (src.includes('?') ? '&' : '?') + 't=' + Date.now();
    });
  }
  function ensureAspectFromLogo(){
    if(aspectSet || !logoImg) return;
    const ar = logoImg.naturalWidth / logoImg.naturalHeight;
    if(ar>0) gauge.style.aspectRatio = `${ar} / 1`;
    aspectSet = true;
  }

  function colorizeBricks(){
    if(!logoImg) return;
    const W=bricksFgEl.clientWidth, H=bricksFgEl.clientHeight; if(!W||!H) return;
    paintCanvas.width=W; paintCanvas.height=H; pctx.clearRect(0,0,W,H);
    // desenha logo centralizado
    const ar=logoImg.naturalWidth/logoImg.naturalHeight; let dw=W, dh=W/ar; if(dh>H){dh=H; dw=H*ar}
    const dx=(W-dw)/2, dy=(H-dh)/2; pctx.drawImage(logoImg,dx,dy,dw,dh);
    const buf=pctx.getImageData(0,0,W,H).data;
    const samp=makeSampler(buf,W,H);
    for(let i=0;i<bricksFg.length;i++){
      const f=bricksFg[i], b=bricksBg[i], x=f._x, y=f._y, w=f._w, h=f._h;
      const pts=[[x+w/2,y+h/2],[x+1,y+1],[x+w-2,y+1],[x+1,y+h-2],[x+w-2,y+h-2],[x+w/2,y+1],[x+w/2,y+h-2],[x+1,y+h/2],[x+w-2,y+h/2]];
      const rs=[],gs=[],bs=[],as=[]; for(const [px,py] of pts){ const d=samp(px,py); rs.push(d[0]); gs.push(d[1]); bs.push(d[2]); as.push(d[3]); }
      const A=median(as), ff=f.querySelector('.fill'), bf=b.querySelector('.fill');
      if (A<100){ ff.style.background='transparent'; bf.style.opacity='1'; }
      else{ const r=median(rs), g=median(gs), bb=median(bs); ff.style.background=mapToPalette(r,g,bb, CONFIG.palette); bf.style.opacity='0'; }
    }
  }

  // Grade de tijolos
  function buildOrder(rows,cols){ const of=[],ob=[]; for(let r=rows-1;r>=0;r--){ for(let c=0;c<cols;c++){ const i=r*cols+c; of.push(bricksFg[i]); ob.push(bricksBg[i]); } } return [of,ob]; }
  function layoutBricks(){
    ensureAspectFromLogo();
    const W=bricksFgEl.clientWidth, H=bricksFgEl.clientHeight; if(!W||!H) return;
    const cols=CONFIG.cols, rows=CONFIG.rows, gap=CONFIG.gap;
    let brickW=Math.floor((W-(cols+1)*gap)/cols); if(brickW<2) brickW=2;
    let offset=Math.floor(brickW/2), gridWEven=cols*brickW+(cols+1)*gap, gridWOdd=gridWEven+offset;
    if(gridWOdd>W){ const extra=gridWOdd-W, reduce=Math.ceil(extra/cols); brickW=Math.max(2,brickW-reduce); offset=Math.floor(brickW/2); gridWEven=cols*brickW+(cols+1)*gap; gridWOdd=gridWEven+offset; }
    const brickH=Math.max(2,Math.floor((H-(rows+1)*gap)/rows));
    const gridWMax=Math.max(gridWEven,gridWOdd); const startXBase=Math.max(gap,Math.floor((W-gridWMax)/2)+gap);
    const total=rows*cols;
    if(bricksFg.length!==total){
      bricksFgEl.innerHTML=''; bricksBgEl.innerHTML=''; bricksFg=[]; bricksBg=[];
      const ff=document.createDocumentFragment(), bb=document.createDocumentFragment();
      for(let i=0;i<total;i++){
        const f=document.createElement('div'); f.className='brick'; f.appendChild(document.createElement('div')).className='fill'; ff.appendChild(f); bricksFg.push(f);
        const b=document.createElement('div'); b.className='brick'; b.appendChild(document.createElement('div')).className='fill'; bb.appendChild(b); bricksBg.push(b);
      }
      bricksFgEl.appendChild(ff); bricksBgEl.appendChild(bb);
    }
    let idx=0; for(let r=0;r<rows;r++){ const startX=startXBase+(r%2?offset:0);
      for(let c=0;c<cols;c++){ const x=startX+c*(brickW+gap), y=gap+r*(brickH+gap);
        const f=bricksFg[idx], b=bricksBg[idx];
        f.style.cssText=`left:${x}px;top:${y}px;width:${brickW}px;height:${brickH}px;`; f._x=x; f._y=y; f._w=brickW; f._h=brickH;
        b.style.cssText=`left:${x}px;top:${y}px;width:${brickW}px;height:${brickH}px;`; idx++; } }
    colorizeBricks(); applyProgress(lastProgress);
  }

  function applyProgress(p){
    p=Math.max(0,Math.min(1,p||0)); lastProgress=p;
    [_orderFg, _orderBg] = buildOrder(CONFIG.rows, CONFIG.cols);
    const total=_orderFg.length; if(!total) return;
    const filled=Math.floor(p*total), frac=(p*total)-filled;
    for(let i=0;i<total;i++){
      const fF=_orderFg[i].querySelector('.fill'), fB=_orderBg[i].querySelector('.fill');
      _orderFg[i].classList.remove('filled','partial'); fF.style.width='0%'; _orderBg[i].classList.remove('filled','partial'); fB.style.width='0%';
      if(i<filled){ _orderFg[i].classList.add('filled'); fF.style.width='100%'; _orderBg[i].classList.add('filled'); fB.style.width='100%'; }
    }
    if(filled<total){
      const fF=_orderFg[filled].querySelector('.fill'), fB=_orderBg[filled].querySelector('.fill'); const percent=Math.round(frac*100)+'%';
      _orderFg[filled].classList.add('partial'); fF.style.width=percent; _orderBg[filled].classList.add('partial'); fB.style.width=percent;
    }
  }

  // Sheets (painel)
  async function fetchProgress(){
    const base=`https://docs.google.com/spreadsheets/d/${CONFIG.sheetId}/gviz/tq`;
    const params=new URLSearchParams({ tqx:'out:json', sheet:CONFIG.sheetName, range:CONFIG.range, t:Date.now()+'' });
    try{
      const res=await fetch(`${base}?${params}`,{ cache:'no-store' }); const txt=await res.text();
      const m=txt.match(/google\.visualization\.Query\.setResponse\((.*)\);/s); const data=JSON.parse(m[1]); const rows=data.table.rows||[];

      const raisedRow = rows.find(r => r.c?.[0]?.v?.toString().trim().toLowerCase() === 'arrecadado');
      const raised = raisedRow ? Number(raisedRow.c?.[1]?.v || 0) : 0;

      const today = new Date(); today.setHours(0,0,0,0);
      let activeGoal=0, activeLabel='Meta';

      for (const r of rows){
        const label=r.c?.[0]?.v?.toString().trim();
        if(!label || label.toLowerCase()==='arrecadado') continue;
        const goal=Number(r.c?.[1]?.v || 0);
        const s=r.c?.[2]?.v, e=r.c?.[3]?.v;
        if(s && e){
          const S=parseGVizDate(s), E=parseGVizDate(e);
          if(S && E && today>=S && today<=E){ activeGoal=goal; activeLabel=label; break; }
        }
      }
      if(!activeGoal && rows.length>1){
        // pega a primeira linha “de meta” depois do arrecadado
        const firstGoalRow = rows.find(r => (r.c?.[0]?.v||'').toString().trim().toLowerCase()!=='arrecadado');
        if(firstGoalRow){
          activeLabel = (firstGoalRow.c?.[0]?.v||'').toString().trim() || 'Meta';
          activeGoal  = Number(firstGoalRow.c?.[1]?.v || 0);
        }
      }

      const p=activeGoal>0 ? (raised/activeGoal) : 0;
      applyProgress(p);

      hud.raised.textContent = formatBRL(raised);
      hud.goal.textContent   = formatBRL(activeGoal);
      hud.goalLabel.textContent = activeLabel;
      hud.pct.textContent    = Math.max(0,Math.min(100,p*100)).toFixed(1).replace('.',',')+'%';
      hud.updated.textContent= new Date().toLocaleString('pt-BR',{dateStyle:'short',timeStyle:'short'});

      devInfo('JS OK');
    }catch(e){
      console.error('Planilha painel:', e);
      devInfo('ERRO ao buscar planilha (ver console).', true);
      if(hud.updated.textContent==='—'){ hud.updated.textContent='(aguardando planilha)'; }
    }
  }

  // Mascote (opcional) — aparece se imagem existir
  (function bootMascot(){
    const img = document.getElementById('mascot');
    const bubble = document.getElementById('bubble');
    const candidates = ['Tio_Jolinho_tijolo.png','Tio_Jolinho_carrinho.png','Tio_Jolinho_martelo.png','mascot.png','mascote.png'];
    (function tryNext(list){
      const src=list.shift(); if(!src){ img.style.display='none'; return; }
      const probe=new Image();
      probe.onload=()=>{ img.src=src+'?v='+Date.now(); img.style.display='block'; };
      probe.onerror=()=>tryNext(list);
      probe.src=src+'?v='+Date.now();
    })(candidates.slice());

    img.addEventListener('click', ()=>{
      img.classList.remove('wave'); void img.offsetWidth; img.classList.add('wave');
      bubble.textContent='Cada Tijolo Conta!'; bubble.classList.add('show');
      clearTimeout(bootMascot._t); bootMascot._t=setTimeout(()=>bubble.classList.remove('show'), 1600);
    });
  })();

  // Boot
  window.addEventListener('resize', debounce(layoutBricks,120));
  window.addEventListener('orientationchange', ()=> setTimeout(layoutBricks,150));
  loadLogo(CONFIG.logo).then(ok=>{ if(ok){ ensureAspectFromLogo(); layoutBricks(); } });
  fetchProgress();
  setInterval(fetchProgress, 30000);
})();
</script>
</body>
</html>