<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tijolômetro — Cada Tijolo Conta</title>

<!-- Performance -->
<link rel="preconnect" href="https://docs.google.com">
<link rel="dns-prefetch" href="https://docs.google.com">

<!-- Social -->
<meta property="og:title" content="Tijolômetro — Cada Tijolo Conta">
<meta property="og:description" content="Acompanhe o progresso da campanha em tempo real e contribua também.">
<meta property="og:type" content="website">
<meta property="og:image" content="logo.png">
<meta name="theme-color" content="#8B1E1E">

<style>
:root{
  /* Visual base */
  --bg:#FFFAF5;
  --grout:#E5DBD1;
  --grid:#CDBFB3;
  --brick-bg-color:#a35a41;

  /* Layout */
  --pad:0px;
  --joint:0.8px;
  --ghost:0.12;
  --panel-max-width:1600px;

  /* Mascote */
  --mascot-scale: 1;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
  background:var(--bg); color:#111;
  display:flex; align-items:center; justify-content:center; padding:12px;
}
@keyframes fadeIn { from { opacity:0; transform: translateY(4px) scale(.99);} to { opacity:1; transform:none; } }
.panel{
  width:min(var(--panel-max-width),98vw);
  background:#fff; border-radius:20px; box-shadow:0 8px 30px rgba(0,0,0,.08);
  padding:16px; display:flex; flex-direction:column; gap:16px; animation:fadeIn .5s ease-out;
}
.gauge{
  position:relative; width:100%;
  border-radius:14px; overflow:hidden; background:#F7EFE7;
  min-height:300px;
}

/* 1) Logo “fantasma” de fundo */
.ghost-logo{
  position:absolute; inset:var(--pad);
  width:calc(100% - (var(--pad) * 2)); height:calc(100% - (var(--pad) * 2));
  margin:auto; object-fit:contain; opacity:var(--ghost);
  filter:grayscale(1) sepia(1) brightness(1.5);
}

/* 2) Tijolos de fundo (área vazada) */
.bricks-bg{ position:absolute; inset:0; }

/* 3) Tijolos da frente (recortados pelo logo) */
.mask-layer{
  position:absolute; inset:0; background:transparent;
  --mask:url('logo.png');
  -webkit-mask-image:var(--mask);   mask-image:var(--mask);
  -webkit-mask-repeat:no-repeat;    mask-repeat:no-repeat;
  -webkit-mask-position:center;     mask-position:center;
  -webkit-mask-size:contain;        mask-size:contain;
}

.bricks{ position:relative; width:100%; height:100% }
.brick{
  position:absolute; background:var(--grout); border-radius:2px; overflow:hidden;
  box-shadow: inset 0 0 0 var(--joint) var(--grid);
}
.brick .fill{
  position:absolute; inset:0; width:0%; height:100%;
  background:var(--brick-bg-color);
  transition:width .35s ease;
}
.brick.filled .fill{ width:100% }

/* HUD */
.hud{
  display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center;
  gap:10px 20px; padding:10px; border:1px solid #eee; border-radius:12px;
  background:#fdfdfd; font-variant-numeric:tabular-nums;
}
.hud b{ font-size:20px } .hud .pct{ font-weight:800 }
.hud .meta{ display:flex; gap:6px; align-items:baseline }

/* Aviso */
.alert{
  position:absolute; left:14px; top:14px; background:#fff3cd; border:1px solid #ffe69c; color:#664d03;
  padding:8px 10px; border-radius:10px; font-size:12px; display:none
}
.alert b{ display:block; margin-bottom:4px }

/* CTA e Compartilhar */
#cta{ text-align:center }
.btn{
  appearance:none; border:0; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer;
}
.btn-primary{ background:#8B1E1E; color:#fff; }
.btn-wa{ background:#25D366; color:#fff; }

/* Mascote */
.mascot{
  position:absolute; left:0; top:0; transform-origin:center;
  pointer-events:none; z-index:20; opacity:.92;
  transition: transform .4s cubic-bezier(.2,.8,.2,1);
}
.mascot svg{ display:block; width:72px; height:auto; transform: scale(var(--mascot-scale)); filter: drop-shadow(0 4px 10px rgba(0,0,0,.18)); }
.mascot .carry{
  position:absolute; width:26px; height:14px; background:#a35a41; border-radius:2px;
  box-shadow: inset 0 0 0 1px #8b6f5c; left:24px; top:18px; animation: carry 1.2s ease-in-out infinite;
}
@keyframes carry{
  0%,100%{ transform: translateY(0) }
  50%{ transform: translateY(-3px) }
}
@keyframes wink{
  0%,94%,100%{ transform:none }
  95%{ transform: translateY(1px) scaleY(.4) }
}
.eye{ transform-origin:center; animation: wink 4.5s infinite; }

/* Acessibilidade: menos movimento */
@media (prefers-reduced-motion: reduce){
  .panel{ animation:none }
  .brick .fill{ transition:none }
  .mascot{ display:none }
}

/* Embed/HUD OFF */
body.embed { background:transparent }
.hud.hidden{ display:none }
</style>
</head>
<body>
  <div class="panel">
    <div class="gauge" id="gauge">
      <div class="alert" id="logoAlert"><b>Logo não carregou</b> — verifique o arquivo logo.png.</div>

      <img class="ghost-logo" id="ghostLogo" alt="logo" />

      <!-- mascote -->
      <div class="mascot" id="mascot" aria-hidden="true" style="display:none">
        <!-- Tio Jolinho (SVG leve) -->
        <svg viewBox="0 0 80 80" role="img" aria-label="Tio Jolinho">
          <!-- capacete -->
          <rect x="18" y="6" width="44" height="18" rx="6" fill="#F2C035"/>
          <rect x="24" y="18" width="32" height="6" rx="3" fill="#C79C1F"/>
          <!-- rosto -->
          <rect x="24" y="24" width="32" height="24" rx="6" fill="#ffdfc4" />
          <!-- olhos -->
          <circle class="eye" cx="34" cy="36" r="2.2" fill="#0A4AA6"/>
          <circle class="eye" cx="46" cy="36" r="2.2" fill="#0A4AA6"/>
          <!-- sorriso -->
          <path d="M33 44 Q40 48 47 44" stroke="#8B1E1E" stroke-width="2" fill="none" />
          <!-- corpo -->
          <rect x="20" y="46" width="40" height="22" rx="6" fill="#0A4AA6"/>
          <!-- braços -->
          <rect x="12" y="48" width="12" height="8" rx="4" fill="#0A4AA6"/>
          <rect x="56" y="48" width="12" height="8" rx="4" fill="#0A4AA6"/>
        </svg>
        <div class="carry"></div>
      </div>

      <div class="bricks-bg" id="bricksBg"></div>

      <div class="mask-layer" id="mask">
        <div class="bricks" id="bricksFg"></div>
      </div>
    </div>

    <div class="hud" id="hud">
      <div><span>Arrecadado</span><br><b id="hudRaised">R$ 0,00</b></div>
      <div class="meta"><span id="hudGoalLabel">Meta</span><br><b id="hudGoal">R$ 0,00</b></div>
      <div><span>Progresso</span><br><span class="pct" id="hudPct">0%</span></div>
      <div style="font-size:11px;color:#777" id="hudUpdated">—</div>
      <div id="shareBox" style="display:none"><button id="whats" class="btn btn-wa">Compartilhar</button></div>
    </div>

    <div id="cta" style="display:none">
      <p id="ctaText" style="margin:8px 0 12px;font-weight:700"></p>
      <a id="ctaBtn" href="#" target="_blank" rel="noopener" class="btn btn-primary">Contribuir agora</a>
    </div>
  </div>

<script>
(function(){
  /* ========== Parâmetros ========== */
  const qs = new URLSearchParams(location.search);
  const CONFIG = {
    // Planilha (rótulo, valor, início, fim)
    sheetId:  qs.get('sheet_id') || '1-_J2DwVSn7LULB55YVPCHQsQ-PRfZYt8oDJhepdXYFY',
    sheetName:qs.get('sheet')    || 'Tijolometro',
    range:    qs.get('range')    || 'A1:D10',

    // Logo e tijolos
    logo:     qs.get('logo') || 'logo.png',
    cols:     parseInt(qs.get('cols') || '120', 10),
    rows:     parseInt(qs.get('rows') || '72',  10),
    brickPx:  parseInt(qs.get('brick_px') || '0', 10), // tamanho alvo; 0 = usa cols/rows
    targetBricks: parseInt(qs.get('target_bricks') || '0', 10), // densidade alvo (~N tijolos)
    gap: 1,

    // Aparência
    pollMs:   parseInt(qs.get('poll_ms') || '30000', 10),
    pad:      qs.get('pad') != null ? parseInt(qs.get('pad'),10) : 0,
    grout:    qs.get('grout') || '',
    joint:    qs.get('joint') || '',
    ghost:    qs.get('ghost') || '',
    palette:  qs.get('palette') || 'brand3',

    // Modo
    embed: qs.get('embed') === '1',
    hudOff: qs.get('hud') === '0',
    share: qs.get('share') === '1',

    // CTA
    cta: qs.get('cta') === '1',
    ctaUrl: qs.get('cta_url') || '',
    ctaText: qs.get('cta_text') || 'Ajude a levantar mais tijolos hoje!',

    // Admin
    admin: qs.get('admin') === '1'
  };

  if (!Number.isNaN(CONFIG.pad)) document.documentElement.style.setProperty('--pad', CONFIG.pad + 'px');
  if (CONFIG.grout) document.documentElement.style.setProperty('--grout', CONFIG.grout);
  if (CONFIG.joint) document.documentElement.style.setProperty('--joint', CONFIG.joint + 'px');
  if (CONFIG.ghost) document.documentElement.style.setProperty('--ghost', CONFIG.ghost);

  if (CONFIG.embed) document.body.classList.add('embed');
  if (CONFIG.hudOff) document.getElementById('hud').classList.add('hidden');

  // Compartilhar / CTA
  if (CONFIG.share) document.getElementById('shareBox').style.display = 'block';
  if (CONFIG.cta && CONFIG.ctaUrl){
    document.getElementById('cta').style.display='block';
    document.getElementById('ctaBtn').href = CONFIG.ctaUrl;
    document.getElementById('ctaText').textContent = CONFIG.ctaText;
  }

  /* ========== Elementos ========== */
  const gauge = document.getElementById('gauge');
  const maskEl = document.getElementById('mask');
  const ghostEl = document.getElementById('ghostLogo');
  const bricksFgEl = document.getElementById('bricksFg');
  const bricksBgEl = document.getElementById('bricksBg');
  const alertBox = document.getElementById('logoAlert');
  const mascot = document.getElementById('mascot');

  const hud = {
    raised: document.getElementById('hudRaised'),
    goal: document.getElementById('hudGoal'),
    pct: document.getElementById('hudPct'),
    updated: document.getElementById('hudUpdated'),
    goalLabel: document.getElementById('hudGoalLabel')
  };

  /* ========== Estado ========== */
  const paintCanvas = document.createElement('canvas');
  const pctx = paintCanvas.getContext('2d', { willReadFrequently:true });
  let logoImg = null, aspectSet = false;
  let bricksFg = [], bricksBg = [];
  let effCols, effRows;
  let lastProgress = 0;
  let lastMilestone = 0;

  /* ========== Utils ========== */
  function setMaskImage(url){ maskEl.style.setProperty('--mask', `url('${url}')`); }
  function formatBRL(n){ try{ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(n);}catch{return 'R$ '+Number(n||0).toLocaleString('pt-BR');} }
  function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
  function tweenNumber(el, to, fmt, ms=600){
    const from = Number((el.textContent||'0').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',','.'))||0;
    const t0 = performance.now(), dur = ms;
    function frame(t){
      const k = Math.min(1, (t - t0)/dur);
      const v = from + (to - from)*k;
      el.textContent = fmt(v);
      if(k<1) requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
  }
  function shareWhats(pctStr){
    const clean = location.href.split('?')[0];
    const msg = `Estamos em ${pctStr}% no Tijolômetro! Contribua: ${clean}`;
    open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
  }
  document.getElementById('whats')?.addEventListener('click', ()=>{
    shareWhats(hud.pct.textContent.replace('%',''));
  });

  function loadLogo(src){
    return new Promise((resolve)=>{
      const im = new Image();
      im.onload = ()=>{ logoImg=im; ghostEl.src=im.src; setMaskImage(im.src); alertBox.style.display='none'; resolve(true); };
      im.onerror = ()=>{ alertBox.style.display='block'; resolve(false); };
      im.src = src + (src.includes('?') ? '&' : '?') + 't=' + Date.now();
    });
  }
  function ensureAspectFromLogo(){
    if(aspectSet || !logoImg) return;
    const ar = logoImg.naturalWidth / logoImg.naturalHeight;
    if(ar>0) gauge.style.aspectRatio = `${ar} / 1`;
    aspectSet = true;
  }

  // Paletas
  const PALETTES = {
    brand2: ['#0A4AA6', '#F2C035'],
    brand3: ['#0A4AA6', '#F2C035', '#8B1E1E']
  };
  function hexToRgb(hex){ const n=parseInt(hex.replace('#',''),16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }
  function dist2(c1,c2){ const dr=c1.r-c2.r,dg=c1.g-c2.g,db=c1.b-c2.b; return dr*dr+dg*dg+db*db; }
  function mapToPalette(r,g,b, name){
    const set = PALETTES[name]; if(!set) return `rgb(${r},${g},${b})`;
    let best=set[0], bestD=Infinity, c1={r,g,b};
    for(const h of set){ const c2=hexToRgb(h); const d=dist2(c1,c2); if(d<bestD){bestD=d; best=h;} }
    return best;
  }

  // Sampler + mediana (cores fiéis)
  function makeSampler(data, W, H){
    return function px(x,y){
      const xi = Math.max(0, Math.min(W-1, Math.round(x)));
      const yi = Math.max(0, Math.min(H-1, Math.round(y)));
      const i = (yi*W + xi) * 4;
      return [data[i], data[i+1], data[i+2], data[i+3]];
    };
  }
  function median(a){ const b=a.slice().sort((m,n)=>m-n); return b[Math.floor(b.length/2)]; }

  // Confete (leve)
  function confetti(){
    const c=document.createElement('canvas'); c.width=innerWidth; c.height=innerHeight;
    c.style.cssText='position:fixed;inset:0;pointer-events:none;z-index:9999'; document.body.appendChild(c);
    const g=c.getContext('2d'); const parts=[...Array(140)].map(()=>({
      x:Math.random()*c.width, y:-20-Math.random()*50, r:2+Math.random()*3,
      vx:(Math.random()-.5)*1.2, vy:1+Math.random()*2.5, a:1
    }));
    const t0=performance.now();
    (function tick(t){
      g.clearRect(0,0,c.width,c.height);
      parts.forEach(p=>{ p.vy+=.02; p.x+=p.vx; p.y+=p.vy; p.a-=.006; g.globalAlpha=Math.max(0,p.a);
        g.fillStyle=['#0A4AA6','#F2C035','#8B1E1E'][p.r|0 % 3]; g.beginPath(); g.arc(p.x,p.y,p.r,0,7); g.fill();
      });
      if (t-t0<2800) requestAnimationFrame(tick); else c.remove();
    })(t0);
  }

  /* ========== Cor dos tijolos (pelo logo) ========== */
  function colorizeBricks(){
    if(!logoImg) return;
    const W = bricksFgEl.clientWidth, H = bricksFgEl.clientHeight; if(!W||!H) return;

    paintCanvas.width=W; paintCanvas.height=H; pctx.clearRect(0,0,W,H);

    const ar = logoImg.naturalWidth / logoImg.naturalHeight;
    let dw=W, dh=W/ar; if(dh>H){ dh=H; dw=H*ar; }
    const dx=(W-dw)/2, dy=(H-dh)/2;
    pctx.drawImage(logoImg, dx, dy, dw, dh);

    const buf = pctx.getImageData(0,0,W,H).data;
    const samp = makeSampler(buf, W, H);

    for(let i=0;i<bricksFg.length;i++){
      const bFg = bricksFg[i], bBg = bricksBg[i];
      const x=bFg._x, y=bFg._y, w=bFg._w, h=bFg._h;

      const pts = [
        [x+w/2, y+h/2],
        [x+1,   y+1], [x+w-2, y+1], [x+1, y+h-2], [x+w-2, y+h-2],
        [x+w/2, y+1], [x+w/2, y+h-2], [x+1, y+h/2], [x+w-2, y+h/2]
      ];
      const rs=[], gs=[], bs=[], as=[];
      for(const [px,py] of pts){ const d=samp(px,py); rs.push(d[0]); gs.push(d[1]); bs.push(d[2]); as.push(d[3]); }
      const A = median(as);

      const fgFill = bFg.querySelector('.fill');
      const bgFill = bBg.querySelector('.fill');

      if (A < 100){ // pouco conteúdo do logo -> mostra fundo
        fgFill.style.background='transparent';
        bgFill.style.opacity='1';
      } else {
        const r=median(rs), g=median(gs), b=median(bs);
        const mapped = mapToPalette(r,g,b, CONFIG.palette);
        fgFill.style.background = mapped;
        bgFill.style.opacity='0';
      }
    }
  }

  /* ========== Grid (meia peça + centralização) ========== */
  let _orderFg=[], _orderBg=[];
  function buildOrder(rows, cols){
    const orderedFg=[],orderedBg=[];
    for(let r=rows-1;r>=0;r--){
      for(let c=0;c<cols;c++){
        const i=r*cols+c; orderedFg.push(bricksFg[i]); orderedBg.push(bricksBg[i]);
      }
    }
    _orderFg=orderedFg; _orderBg=orderedBg;
  }

  function layoutBricks(){
    ensureAspectFromLogo();
    const W = bricksFgEl.clientWidth, H = bricksFgEl.clientHeight;
    if(!W || !H) return;

    // Estratégia A: tamanho alvo
    if (CONFIG.brickPx && CONFIG.brickPx > 0) {
      const brickWtarget = CONFIG.brickPx;
      const brickHtarget = Math.round(brickWtarget * 0.6);
      effCols = Math.max(20, Math.floor((W - CONFIG.gap) / (brickWtarget + CONFIG.gap)));
      effRows = Math.max(12, Math.floor((H - CONFIG.gap) / (brickHtarget + CONFIG.gap)));
    } else if (CONFIG.targetBricks > 0) {
      // Estratégia B: densidade alvo (~N tijolos)
      const ar = W / H;
      const rows = Math.max(12, Math.round(Math.sqrt(CONFIG.targetBricks / (ar*1.0))));
      const cols = Math.max(20, Math.round(rows * ar));
      effCols = cols; effRows = rows;
    }

    const cols = (typeof effCols === 'number' && effCols > 0) ? effCols : CONFIG.cols;
    const rows = (typeof effRows === 'number' && effRows > 0) ? effRows : CONFIG.rows;
    const gap  = CONFIG.gap;

    let brickW = Math.floor((W - (cols + 1) * gap) / cols);
    if (brickW < 2) brickW = 2;

    let offset = Math.floor(brickW / 2);
    let gridWEven = cols * brickW + (cols + 1) * gap;
    let gridWOdd  = gridWEven + offset;
    if (gridWOdd > W) {
      const extra  = gridWOdd - W;
      const reduce = Math.ceil(extra / cols);
      brickW = Math.max(2, brickW - reduce);
      offset = Math.floor(brickW / 2);
      gridWEven = cols * brickW + (cols + 1) * gap;
      gridWOdd  = gridWEven + offset;
    }

    const brickH = Math.max(2, Math.floor((H - (rows + 1) * gap) / rows));

    const gridWMax = Math.max(gridWEven, gridWOdd);
    const startXBase = Math.max(gap, Math.floor((W - gridWMax) / 2) + gap);

    const total = rows * cols;
    if (bricksFg.length !== total){
      bricksFgEl.innerHTML = ''; bricksBgEl.innerHTML = '';
      bricksFg = []; bricksBg = [];
      const fragFg = document.createDocumentFragment();
      const fragBg = document.createDocumentFragment();
      for (let i=0;i<total;i++){
        const elF = document.createElement('div'); elF.className='brick';
        elF.appendChild(document.createElement('div')).className='fill';
        fragFg.appendChild(elF); bricksFg.push(elF);

        const elB = document.createElement('div'); elB.className='brick';
        elB.appendChild(document.createElement('div')).className='fill';
        fragBg.appendChild(elB); bricksBg.push(elB);
      }
      bricksFgEl.appendChild(fragFg);
      bricksBgEl.appendChild(fragBg);
    }

    let idx = 0;
    for (let r=0; r<rows; r++){
      const startX = startXBase + (r % 2 ? offset : 0);
      for (let c=0; c<cols; c++){
        const x = startX + c * (brickW + gap);
        const y = gap + r * (brickH + gap);

        const bFg = bricksFg[idx];
        bFg.style.cssText = `left:${x}px;top:${y}px;width:${brickW}px;height:${brickH}px;`;
        bFg._x = x; bFg._y = y; bFg._w = brickW; bFg._h = brickH;

        const bBg = bricksBg[idx];
        bBg.style.cssText = `left:${x}px;top:${y}px;width:${brickW}px;height:${brickH}px;`;

        idx++;
      }
    }

    buildOrder(rows, cols);
    colorizeBricks();
    applyProgress(lastProgress, rows, cols);
    placeMascot(); // reacomoda se a tela mudou
  }

  function applyProgress(p, rows, cols){
    p=Math.max(0,Math.min(1,p||0)); lastProgress=p;
    const orderFg=_orderFg, orderBg=_orderBg; const total=orderFg.length;
    if (total === 0) return;

    const filled=Math.floor(p*total), frac=(p*total)-filled;

    for(let i=0;i<total;i++){
      const fF=orderFg[i].querySelector('.fill'), fB=orderBg[i].querySelector('.fill');
      orderFg[i].classList.remove('filled','partial'); fF.style.width='0%';
      orderBg[i].classList.remove('filled','partial'); fB.style.width='0%';
      if(i<filled){ orderFg[i].classList.add('filled'); fF.style.width='100%'; orderBg[i].classList.add('filled'); fB.style.width='100%'; }
    }
    if(filled<total){
      const fF=orderFg[filled].querySelector('.fill'), fB=orderBg[filled].querySelector('.fill');
      const percent=Math.round(frac*100)+'%';
      orderFg[filled].classList.add('partial'); fF.style.width=percent;
      orderBg[filled].classList.add('partial'); fB.style.width=percent;
    }
    placeMascot(); // reposiciona no “próximo tijolo”
  }

  /* ========== Mascote (posiciona no próximo tijolo) ========== */
  function placeMascot(){
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
    const total = _orderFg.length; if (!total) return;

    const nextIndex = Math.min(total-1, Math.floor(lastProgress * total)); // próximo tijolo
    const b = _orderFg[nextIndex]; if (!b) return;

    const rect = b.getBoundingClientRect();
    const gaugeRect = gauge.getBoundingClientRect();
    const cx = rect.left - gaugeRect.left + rect.width/2;
    const cy = rect.top  - gaugeRect.top  - 10; // acima do tijolo

    mascot.style.display = 'block';
    mascot.style.transform = `translate(${Math.round(cx-36)}px, ${Math.round(cy-48)}px)`;
  }

  /* ========== Parse robusto de datas ========== */
  function parseDateCell(cell){
    let v = (cell && typeof cell === 'object' && 'v' in cell) ? cell.v : cell;
    if (v && typeof v === 'object') {
      if ('f' in v && typeof v.f === 'string') return parseDateCell(v.f);
      if ('v' in v) return parseDateCell(v.v);
    }
    if (!v) return null;

    if (typeof v === 'string') {
      const gv = v.match(/Date\((\d+),\s*(\d+),\s*(\d+)/i);
      if (gv) return new Date(+gv[1], +gv[2], +gv[3]);

      const iso = v.match(/^(\d{4})[-\/.](\d{1,2})[-\/.](\d{1,2})$/);
      if (iso) return new Date(+iso[1], +iso[2]-1, +iso[3]);

      const br = v.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
      if (br) {
        const d=+br[1], m=+br[2], y=+br[3] < 100 ? 2000+ +br[3] : +br[3];
        return new Date(y, m-1, d);
      }
      return null;
    }
    if (typeof v === 'number') {
      const base = Date.UTC(1899,11,30);
      return new Date(base + v*86400*1000);
    }
    return null;
  }

  /* ========== Busca da planilha + milestones + persistência ========== */
  async function fetchProgress(){
    const base = `https://docs.google.com/spreadsheets/d/${CONFIG.sheetId}/gviz/tq`;
    const params = new URLSearchParams({ tqx:'out:json', sheet:CONFIG.sheetName, range:CONFIG.range, t:Date.now()+'' });

    try{
      const res = await fetch(`${base}?${params}`, { cache:'no-store' });
      const txt = await res.text();
      const m = txt.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
      const data = JSON.parse(m[1]);
      const rows = data.table.rows || [];

      let raised = 0;
      const campaigns = [];
      for (const r of rows) {
        const label = r.c?.[0]?.v?.toString().trim();
        if (!label) continue;
        const value = Number(r.c?.[1]?.v || r.c?.[1]?.f || 0);

        if (label.toLowerCase() === 'arrecadado') { raised = Number(value||0); continue; }

        const start = parseDateCell(r.c?.[2]);
        const end   = parseDateCell(r.c?.[3]);
        campaigns.push({ label, goal:Number(value||0), start, end });
      }

      const today = new Date(); today.setHours(0,0,0,0);
      let active = campaigns.find(c => c.start && c.end && today >= c.start && today <= c.end);
      if (!active) active = campaigns.find(c => c.goal > 0) || { label:'Meta', goal:0 };

      const goal = Number(active.goal || 0);
      const pRaw = goal > 0 ? (raised / goal) : 0;
      const p = Math.max(0, Math.min(1, pRaw));

      applyProgress(p);
      tweenNumber(hud.raised, raised, n=>formatBRL(n));
      tweenNumber(hud.goal,   goal,   n=>formatBRL(n));
      hud.goalLabel.textContent = active.label || 'Meta';
      hud.pct.textContent = (pRaw*100).toFixed(1).replace('.',',')+'%';
      hud.updated.textContent= 'Atualizado em ' + new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});

      // milestones (25/50/75/100)
      const pctVal = pRaw*100;
      [25,50,75,100].some(m => {
        if (lastMilestone < m && pctVal >= m) { confetti(); lastMilestone = m; return true; }
      });

      try { localStorage.setItem('tj:last', JSON.stringify({p,raised,goal,ts:Date.now()})); } catch{}
    }catch(e){
      console.error('Erro ao buscar dados da planilha:', e);
      const last = localStorage.getItem('tj:last');
      if (last){
        const {p,raised,goal,ts} = JSON.parse(last);
        applyProgress(p);
        hud.raised.textContent = formatBRL(raised);
        hud.goal.textContent   = formatBRL(goal);
        hud.pct.textContent    = (p*100).toFixed(1).replace('.',',')+'%';
        hud.updated.textContent= 'Offline — último: ' + new Date(ts).toLocaleString('pt-BR');
      }else{
        if(hud.updated.textContent==='—'){ hud.updated.textContent='(Erro na planilha)'; }
      }
    }
  }

  /* ========== Observers / Eventos ========== */
  const ro = new ResizeObserver(()=> layoutBricks());
  ro.observe(gauge);

  window.addEventListener('orientationchange', ()=> setTimeout(layoutBricks, 150));

  loadLogo(CONFIG.logo).then((ok)=>{ if(ok){ ensureAspectFromLogo(); layoutBricks(); } else { layoutBricks(); } });
  fetchProgress(); setInterval(fetchProgress, CONFIG.pollMs);

  // Admin quick panel (no-UI minimal)
  if (CONFIG.admin){
    const box = document.createElement('div');
    box.style.cssText='position:fixed;right:12px;bottom:12px;background:#fff;border:1px solid #ddd;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.15);padding:10px;z-index:99999';
    box.innerHTML = `
      <div style="font-weight:700;margin-bottom:6px">Ajustes</div>
      <label>Ghost <input type="number" step="0.01" id="aGhost" style="width:70px" /></label><br>
      <label>Tijolo(px) <input type="number" id="aBrick" style="width:70px" /></label><br>
      <button id="aApply" class="btn btn-primary" style="margin-top:6px">Aplicar</button>
    `;
    document.body.appendChild(box);
    document.getElementById('aGhost').value = getComputedStyle(document.documentElement).getPropertyValue('--ghost').trim() || '0.12';
    document.getElementById('aBrick').value = CONFIG.brickPx || 0;
    document.getElementById('aApply').onclick = ()=>{
      const g = parseFloat(document.getElementById('aGhost').value||'0.12');
      document.documentElement.style.setProperty('--ghost', isFinite(g)? g : 0.12);
      const bp = parseInt(document.getElementById('aBrick').value||'0',10);
      if (isFinite(bp)){ CONFIG.brickPx = bp; effCols=effRows=undefined; layoutBricks(); }
    };
  }
})();
</script>
</body>
</html>
